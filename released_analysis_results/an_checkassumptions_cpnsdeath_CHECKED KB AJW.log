-------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-3\analysis\output/an_checkassumptions_cpnsdeath.log
  log type:  text
 opened on:  12 May 2020, 19:40:51

. 
. 
. use "cr_create_analysis_dataset_STSET_`outcome'.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.reduced_kidney_function_cat           ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         other_immunosuppression                 ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. * Set as survival outcome
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id) 

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17283279  total observations
        447  observations end on or before enter()
------------------------------------------------------------------------------
   17282832  observations remaining, representing
   17282832  subjects
      5,651  failures in single-failure-per-subject data
 1.4499e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        84

. 
. 
.                         
. * Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  ethnicity(0)
   1:   2736.11 /        1 =    2736.1070

. if _rc==0 {
.         
.         estimates

-------------------------------------------------------------------------------------------------------
active results
-------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,282,832                  Number of obs    =  17,282,832
No. of failures =        5,651
Time at risk    =   1449942098
                                                LR chi2(36)      =    18789.77
Log likelihood  =   -66602.213                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |    1.13192   .0273733     5.12   0.000     1.079521    1.186863
                         age2 |   .9628658   .0519128    -0.70   0.483     .8663101    1.070183
                         age3 |   1.047567    .132372     0.37   0.713     .8177546    1.341964
                       1.male |   1.979978   .0569777    23.74   0.000     1.871394    2.094861
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.264374   .0437958     6.77   0.000     1.181385    1.353193
          Obese II (35-39.9)  |   1.552663   .0789598     8.65   0.000     1.405367    1.715397
             Obese III (40+)  |   2.244601   .1504945    12.06   0.000     1.968196    2.559823
                              |
                 smoke_nomiss |
                      Former  |   1.246701   .0383438     7.17   0.000     1.173768    1.324164
                     Current  |   .8765587   .0507536    -2.28   0.023     .7825203     .981898
                              |
                          imd |
                           2  |   1.133522   .0511419     2.78   0.005      1.03759    1.238324
                           3  |   1.231045   .0552692     4.63   0.000     1.127349     1.34428
                           4  |   1.486356   .0657425     8.96   0.000      1.36293    1.620959
             5 most deprived  |   1.733897   .0785947    12.14   0.000     1.586499     1.89499
                              |
           1.htdiag_or_highbp |    .934567   .0303033    -2.09   0.037     .8770216    .9958882
1.chronic_respiratory_disease |   1.783881   .0606524    17.02   0.000     1.668879    1.906808
                              |
                    asthmacat |
                 Yes, no OCS  |   1.107006   .0450601     2.50   0.013      1.02212     1.19894
                Yes with OCS  |   1.250217   .0918718     3.04   0.002     1.082518    1.443896
                              |
    1.chronic_cardiac_disease |   1.247208   .0374503     7.36   0.000     1.175925    1.322812
                              |
                      diabcat |
         Controlled diabetes  |   1.481593   .0503676    11.56   0.000     1.386091    1.583674
       Uncontrolled diabetes  |   2.265623   .0944799    19.61   0.000     2.087811    2.458578
  Diabetes, no hba1c measure  |   1.822524   .1311296     8.34   0.000     1.582814    2.098537
                              |
            cancer_exhaem_cat |
                   Last year  |   1.557582   .1532932     4.50   0.000     1.284333    1.888965
               2-5 years ago  |   1.180274   .0776401     2.52   0.012     1.037503    1.342691
                    5+ years  |   .9575628   .0434533    -0.96   0.339     .8760734    1.046632
                              |
              cancer_haem_cat |
                   Last year  |   3.344638   .6463274     6.25   0.000     2.290131    4.884698
               2-5 years ago  |   3.058155   .3472812     9.84   0.000     2.447923    3.820508
                    5+ years  |     1.8597   .1865312     6.19   0.000     1.527798    2.263706
                              |
      1.chronic_liver_disease |    1.62586   .1583507     4.99   0.000     1.343322    1.967822
            1.stroke_dementia |   1.784802   .0653043    15.83   0.000      1.66129    1.917497
                1.other_neuro |   2.471448   .1460524    15.31   0.000     2.201147    2.774943
                              |
  reduced_kidney_function_cat |
    Stage 3a/3b egfr 30-60    |   1.554674   .0504024    13.61   0.000      1.45896    1.656667
           Stage 4/5 egfr<30  |   3.488515   .1804599    24.15   0.000     3.152159    3.860762
                              |
           1.organ_transplant |   3.638394   .5353668     8.78   0.000     2.726847    4.854658
                     1.spleen |    1.40708   .2947127     1.63   0.103     .9333292    2.121304
           1.ra_sle_psoriasis |   1.230381   .0566163     4.51   0.000     1.124272    1.346505
      other_immunosuppression |   1.815522   .2762957     3.92   0.000      1.34729    2.446481
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
.         * estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agesp
> line_bmicat_noeth, replace
. 
.         /*  Proportional Hazards test  */
.         
.         * Based on Schoenfeld residuals
.         timer clear 
.         timer on 1
.         if e(N_fail)>0 estat phtest, d

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      age1        |      0.02148         2.47        1         0.1157
      age2        |     -0.02775         4.11        1         0.0427
      age3        |      0.03040         4.92        1         0.0266
      0b.male     |            .            .        1             .
      1.male      |     -0.02694         4.13        1         0.0422
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.01978         2.21        1         0.1369
      3.obese4cat |      0.00201         0.02        1         0.8799
      4.obese4cat |     -0.01782         1.79        1         0.1806
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.01298         0.94        1         0.3313
      3.smoke_no~s|      0.02108         2.58        1         0.1082
      1b.imd      |            .            .        1             .
      2.imd       |      0.03326         6.22        1         0.0126
      3.imd       |      0.03341         6.24        1         0.0125
      4.imd       |      0.04630        11.99        1         0.0005
      5.imd       |      0.03749         7.86        1         0.0051
      0b.htdiag_~p|            .            .        1             .
      1.htdiag_o~p|     -0.00637         0.24        1         0.6228
      0b.c~respi~e|            .            .        1             .
      1.c~respir~e|     -0.04198        10.46        1         0.0012
      1b.asthmacat|            .            .        1             .
      2.asthmacat |     -0.00925         0.48        1         0.4872
      3.asthmacat |     -0.02375         3.23        1         0.0723
      0b.c~cardi~e|            .            .        1             .
      1.c~cardia~e|     -0.03787         8.54        1         0.0035
      1b.diabcat  |            .            .        1             .
      2.diabcat   |      0.00127         0.01        1         0.9234
      3.diabcat   |     -0.03897         8.90        1         0.0029
      4.diabcat   |      0.01301         0.97        1         0.3258
      1b.c~exhae~t|            .            .        1             .
      2.cancer_e~t|     -0.00994         0.56        1         0.4540
      3.cancer_e~t|     -0.02783         4.40        1         0.0359
      4.cancer_e~t|      0.01225         0.85        1         0.3565
      1b.cancer_h~|            .            .        1             .
      2.cancer_h~t|     -0.00215         0.03        1         0.8714
      3.cancer_h~t|     -0.01308         0.97        1         0.3242
      4.cancer_h~t|      0.01561         1.39        1         0.2385
      0b.c~liver~e|            .            .        1             .
      1.c~liver_~e|     -0.01938         2.21        1         0.1372
      0b.stroke_~a|            .            .        1             .
      1.stroke_d~a|      0.03611         7.86        1         0.0050
      0b.other_n~o|            .            .        1             .
      1.other_ne~o|      0.00994         0.58        1         0.4472
      1b.reduced~t|            .            .        1             .
      2.reduced_~t|     -0.00034         0.00        1         0.9788
      3.reduced_~t|      0.00887         0.50        1         0.4780
      0b.organ_t~t|            .            .        1             .
      1.organ_tr~t|      0.02893         4.82        1         0.0281
      0b.spleen   |            .            .        1             .
      1.spleen    |     -0.01192         0.81        1         0.3684
      0b.ra_sle_~s|            .            .        1             .
      1.ra_sle_p~s|     -0.01339         1.02        1         0.3133
      other_immu~n|     -0.01682         1.59        1         0.2071
      ------------+---------------------------------------------------
      global test |                    122.79       36         0.0000
      ----------------------------------------------------------------
.         timer off 1
.         timer list
   1:   2867.36 /        1 =    2867.3630
.         
.         
.         /*  Concordance statistic  */
.         
.         timer clear 
.         timer on 2
.         set seed 12437
.         
.         qui count if `outcome'==0
.         local N0 = r(N)
.         local p0 = 5000/`N0'
.         qui count if `outcome'==1
.         local N1 = r(N)
.         local p1 = 5000/`N1'    
.         
.         noi di "Fraction of controls to be used" `p0'
Fraction of controls to be used.00028939
.         noi di "Fraction of cases to be used" `p1'
Fraction of cases to be used.88479915
.         local csum = 0
.         forvalues i = 1 (1) 10 {
  2.                 gen     rsample`i' = uniform()<`p0' if `outcome'==0
  3.                 replace rsample`i' = uniform()<`p1' if `outcome'==1
  4.                 estat concordance if rsample`i'==1
  5.                 local cstat`i' =  r(C)
  6.                 noi di "C-statistic in `i' th sample = " `cstat`i''
  7.                 local csum = `csum' + `cstat`i''
  8.                 drop rsample`i'
  9.         }
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7754
                            Somers' D =   0.5509
C-statistic in 1 th sample = .77542734
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7783
                            Somers' D =   0.5566
C-statistic in 2 th sample = .77831171
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7780
                            Somers' D =   0.5560
C-statistic in 3 th sample = .77801606
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7803
                            Somers' D =   0.5607
C-statistic in 4 th sample = .7803382
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7778
                            Somers' D =   0.5556
C-statistic in 5 th sample = .77781727
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7788
                            Somers' D =   0.5575
C-statistic in 6 th sample = .77876062
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7794
                            Somers' D =   0.5589
C-statistic in 7 th sample = .77942966
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7811
                            Somers' D =   0.5623
C-statistic in 8 th sample = .78113394
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7820
                            Somers' D =   0.5639
C-statistic in 9 th sample = .78196887
(5,651 missing values generated)
(5,651 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7770
                            Somers' D =   0.5540
C-statistic in 10 th sample = .77699007
.         local csum = `csum'/10
.         noi di "Average C-statistic = " `csum'
Average C-statistic = .77881937
.         timer off 2
.         timer list      
   2:   1338.84 /        1 =    1338.8390
.         
.         
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. 
. 
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-3\analysis\output/an_checkassumptions_cpnsdeath.log
  log type:  text
 closed on:  12 May 2020, 21:42:10
-------------------------------------------------------------------------------------------------------
