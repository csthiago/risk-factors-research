-------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/rp_parametric_survival_m
> odels_cf.log
  log type:  text
 opened on:  15 May 2020, 01:11:28

. 
. use "cr_create_analysis_dataset_STSET_cpnsdeath.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. 
. 
. ***************************************
. *   Kaplan Meier vs unadjusted gamma  *
. ***************************************
. 
. 
. * KM survival 
. sts graph, by(male)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

. graph save a.gph, replace
(note: file a.gph not found)
(file a.gph saved)

. sts gen surv_km_male = s

. 
. 
. * Generalised gamma
. streg i.male, dist(ggamma) 

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Fitting constant-only model:

Iteration 0:   log likelihood = -52242.648  (not concave)
Iteration 1:   log likelihood = -52120.837  (not concave)
Iteration 2:   log likelihood =  -51984.03  (not concave)
Iteration 3:   log likelihood = -51859.767  (not concave)
Iteration 4:   log likelihood = -51746.074  (not concave)
Iteration 5:   log likelihood =  -51627.84  (not concave)
Iteration 6:   log likelihood = -51521.398  (not concave)
Iteration 7:   log likelihood =  -51422.44  (not concave)
Iteration 8:   log likelihood = -51319.362  (not concave)
Iteration 9:   log likelihood = -51218.096  (not concave)
Iteration 10:  log likelihood = -51117.703  (not concave)
Iteration 11:  log likelihood = -51020.276  (not concave)
Iteration 12:  log likelihood = -50922.454  (not concave)
Iteration 13:  log likelihood = -50827.089  (not concave)
Iteration 14:  log likelihood = -50731.874  (not concave)
Iteration 15:  log likelihood = -50639.384  (not concave)
Iteration 16:  log likelihood = -50547.036  (not concave)
Iteration 17:  log likelihood = -50457.356  (not concave)
Iteration 18:  log likelihood = -50368.038  (not concave)
Iteration 19:  log likelihood = -50281.483  (not concave)
Iteration 20:  log likelihood = -50195.428  (not concave)
Iteration 21:  log likelihood = -50112.172  (not concave)
Iteration 22:  log likelihood = -50029.594  (not concave)
Iteration 23:  log likelihood = -49949.871  (not concave)
Iteration 24:  log likelihood = -49870.988  (not concave)
Iteration 25:  log likelihood = -49794.993  (not concave)
Iteration 26:  log likelihood = -49719.998  (not concave)
Iteration 27:  log likelihood =  -49647.91  (not concave)
Iteration 28:  log likelihood = -49576.963  (not concave)
Iteration 29:  log likelihood = -49508.919  (not concave)
Iteration 30:  log likelihood = -49442.136  (not concave)
Iteration 31:  log likelihood = -49378.228  (not concave)
Iteration 32:  log likelihood = -49315.675  (not concave)
Iteration 33:  log likelihood = -49255.941  (not concave)
Iteration 34:  log likelihood = -49197.629  (not concave)
Iteration 35:  log likelihood = -49142.055  (not concave)
Iteration 36:  log likelihood = -49087.942  (not concave)
Iteration 37:  log likelihood = -49036.463  (not concave)
Iteration 38:  log likelihood = -48986.459  
Iteration 39:  log likelihood = -48883.151  
Iteration 40:  log likelihood = -48077.359  
Iteration 41:  log likelihood = -48002.881  
Iteration 42:  log likelihood = -47958.417  (not concave)
Iteration 43:  log likelihood = -47958.154  
Iteration 44:  log likelihood = -47951.524  
Iteration 45:  log likelihood = -47939.294  
Iteration 46:  log likelihood = -47926.034  
Iteration 47:  log likelihood = -47906.239  
Iteration 48:  log likelihood = -47899.499  
Iteration 49:  log likelihood = -47893.205  
Iteration 50:  log likelihood = -47887.066  
Iteration 51:  log likelihood = -47881.459  
Iteration 52:  log likelihood =  -47874.27  
Iteration 53:  log likelihood = -47868.458  
Iteration 54:  log likelihood = -47857.441  
Iteration 55:  log likelihood =  -47849.67  (not concave)
Iteration 56:  log likelihood = -47848.686  (not concave)
Iteration 57:  log likelihood = -47848.614  
Iteration 58:  log likelihood = -47845.963  
Iteration 59:  log likelihood = -47832.208  
Iteration 60:  log likelihood = -47823.001  
Iteration 61:  log likelihood = -47811.663  
Iteration 62:  log likelihood = -47807.783  
Iteration 63:  log likelihood = -47792.207  
Iteration 64:  log likelihood = -47778.802  
Iteration 65:  log likelihood =  -47776.08  
Iteration 66:  log likelihood = -47765.033  (not concave)
Iteration 67:  log likelihood = -47764.891  
Iteration 68:  log likelihood = -47761.598  
Iteration 69:  log likelihood = -47738.381  (not concave)
Iteration 70:  log likelihood = -47738.085  
Iteration 71:  log likelihood = -47732.729  
Iteration 72:  log likelihood = -47721.071  
Iteration 73:  log likelihood = -47706.663  
Iteration 74:  log likelihood = -47699.158  
Iteration 75:  log likelihood = -47676.213  
Iteration 76:  log likelihood = -47668.702  
Iteration 77:  log likelihood = -47652.839  
Iteration 78:  log likelihood = -47627.978  
Iteration 79:  log likelihood =  -47605.44  
Iteration 80:  log likelihood = -47592.486  
Iteration 81:  log likelihood = -47561.547  
Iteration 82:  log likelihood = -47526.277  
Iteration 83:  log likelihood =     -47496  
Iteration 84:  log likelihood = -47476.923  
Iteration 85:  log likelihood = -47445.107  
Iteration 86:  log likelihood = -47428.496  
Iteration 87:  log likelihood = -47397.847  
Iteration 88:  log likelihood = -47372.199  
Iteration 89:  log likelihood = -47372.167  
Iteration 90:  log likelihood = -47372.167  

Fitting full model:

Iteration 0:   log likelihood = -47372.167  
Iteration 1:   log likelihood = -47270.295  
Iteration 2:   log likelihood = -47259.835  
Iteration 3:   log likelihood = -47259.759  
Iteration 4:   log likelihood = -47259.759  

Generalized gamma AFT regression

No. of subjects =   17,282,832                  Number of obs    =  17,282,832
No. of failures =        5,651
Time at risk    =   1449942098
                                                LR chi2(1)       =      224.82
Log likelihood  =   -47259.759                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      1.male |   -.100898   .0067694   -14.91   0.000    -.1141657   -.0876303
       _cons |     5.8782   .0561887   104.62   0.000     5.768073    5.988328
-------------+----------------------------------------------------------------
    /lnsigma |   2.582893   .0102191   252.75   0.000     2.562864    2.602922
      /kappa |  -62.50017   2.052191   -30.46   0.000    -66.52239   -58.47795
-------------+----------------------------------------------------------------
       sigma |   13.23537   .1352537                      12.97292    13.50314
------------------------------------------------------------------------------

. predict surv_gg_male, surv
(447 missing values generated)

. estat ic

Akaike's information criterion and Bayesian information criterion

-----------------------------------------------------------------------------
       Model |          N   ll(null)  ll(model)      df        AIC        BIC
-------------+---------------------------------------------------------------
           . | 17,282,832  -47372.17  -47259.76       4   94527.52   94586.18
-----------------------------------------------------------------------------
Note: BIC uses N = number of observations. See [R] BIC note.

. 
. 
. * Royston Parmar
. stpm2 male,     scale(hazard) df(5) eform

Iteration 0:   log likelihood = -47050.096  
Iteration 1:   log likelihood = -47010.794  
Iteration 2:   log likelihood = -47010.576  
Iteration 3:   log likelihood = -47010.576  

Log likelihood = -47010.576                     Number of obs     = 17,282,832

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        male |   1.711257    .047168    19.49   0.000     1.621262    1.806247
       _rcs1 |   2.664717    .155672    16.78   0.000     2.376426    2.987983
       _rcs2 |   1.179748   .0195239     9.99   0.000     1.142095    1.218641
       _rcs3 |   1.004886    .001437     3.41   0.001     1.002073    1.007706
       _rcs4 |    1.00002   .0001968     0.10   0.919     .9996344    1.000406
       _rcs5 |   1.000068   .0000488     1.39   0.164     .9999724    1.000164
       _cons |   .0002345   5.15e-06  -380.76   0.000     .0002246    .0002448
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

. predict surv_rp_male, surv

. estat ic

Akaike's information criterion and Bayesian information criterion

-----------------------------------------------------------------------------
       Model |          N   ll(null)  ll(model)      df        AIC        BIC
-------------+---------------------------------------------------------------
           . | 17,282,832          .  -47010.58       7   94035.15   94137.81
-----------------------------------------------------------------------------
Note: BIC uses N = number of observations. See [R] BIC note.

. 
. 
. 
. * Graph survival curves
. twoway  (line surv_km_male _t if male==1, sort) ///
>                 (line surv_km_male _t if male==0, sort), yscale(range(0 1)) title("Kaplan-Meier")

. graph save b.gph, replace
(note: file b.gph not found)
(file b.gph saved)

. 
. twoway  (line surv_gg_male _t if male==1, sort) ///
>                 (line surv_gg_male _t if male==0, sort), yscale(range(0 1)) title("Generalised Gamma"
> )

. graph save c.gph, replace
(note: file c.gph not found)
(file c.gph saved)

.         
. twoway  (line surv_rp_male _t if male==1, sort) ///
>                 (line surv_rp_male _t if male==0, sort), yscale(range(0 1)) title("Royston-Parmar")

. graph save d.gph, replace
(note: file d.gph not found)
(file d.gph saved)

. 
. * Combine survival curves
. graph combine a.gph b.gph c.gph d.gph, col(4)

. graph export "output/survival.svg", as(svg) replace
(note: file output/survival.svg not found)
(file output/survival.svg written in SVG format)

. 
. erase a.gph

. erase b.gph

. erase c.gph

. erase d.gph

. 
. 
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/rp_parametric_survival_m
> odels_cf.log
  log type:  text
 closed on:  15 May 2020, 09:16:44
-------------------------------------------------------------------------------------------------------
