----------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_sensan_earlieradmincensoring_onscoviddeath.log
  log type:  text
 opened on:   7 Jul 2020, 00:35:44

. 
. **********************************
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. *CHANGE ADMIN CENSORING DATE
. replace `outcome'censor_date = date("06/04/2020", "DMY")
(17,278,392 real changes made)

. 
. if "`outcome'"=="cpnsdeath" {
.         replace stime_cpnsdeath         = min(cpnsdeathcensor_date,     died_date_cpns, died_date_ons)
.         replace cpnsdeath               = 0 if (died_date_cpns          > cpnsdeathcensor_date) 
. }

. else if "`outcome'"=="onscoviddeath" {
.         replace stime_onscoviddeath     = min(onscoviddeathcensor_date,         died_date_ons)
(17,241,924 real changes made)
.         replace onscoviddeath           = 0 if (died_date_onscovid              > onscoviddeathcensor_date) 
(8,110 real changes made)
. }

. else error 198 /*this dofile not valid for outcomes other than above*/

. 
. *STSET
. stset stime_`outcome', fail(`outcome')                          ///
>         id(patient_id) enter(enter_date) origin(enter_date)

                id:  patient_id
     failure event:  onscoviddeath != 0 & onscoviddeath < .
obs. time interval:  (stime_onscoviddeath[_n-1], stime_onscoviddeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17278392  total observations
        457  observations end on or before enter()
------------------------------------------------------------------------------
   17277935  observations remaining, representing
   17277935  subjects
      2,816  failures in single-failure-per-subject data
 1.1220e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        65

. **********************************
. 
. 
. *RUN MAIN MODELS
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.reduced_kidney_function_cat   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
.  
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  bp("i.htdiag_or_highbp") ethnicity(0)
   1:   2812.38 /        1 =    2812.3750

. if _rc==0{
. estimates

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,277,935                  Number of obs    =  17,277,935
No. of failures =        2,816
Time at risk    =   1122020325
                                                LR chi2(36)      =     9588.13
Log likelihood  =   -33099.496                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.113077   .0385657     3.09   0.002     1.039999     1.19129
                         age2 |   1.016354   .0787411     0.21   0.834     .8731703    1.183017
                         age3 |   .9135452   .1660822    -0.50   0.619     .6397082    1.304603
                       1.male |   1.893689   .0769798    15.71   0.000     1.748666     2.05074
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.296663   .0638062     5.28   0.000     1.177446     1.42795
          Obese II (35-39.9)  |   1.571362    .114301     6.21   0.000     1.362573    1.812145
             Obese III (40+)  |   2.695679   .2411156    11.09   0.000     2.262207    3.212211
                              |
                 smoke_nomiss |
                      Former  |   1.273749   .0555529     5.55   0.000     1.169391     1.38742
                     Current  |   .9290965   .0756835    -0.90   0.367     .7919953    1.089931
                              |
                          imd |
                           2  |   .9592854   .0598655    -0.67   0.505     .8488432    1.084097
                           3  |   .9950639   .0621656    -0.08   0.937     .8803858     1.12468
                           4  |   1.255328   .0762083     3.75   0.000     1.114506    1.413942
             5 most deprived  |   1.412114   .0895221     5.44   0.000     1.247116     1.59894
                              |
           1.htdiag_or_highbp |   .9478765   .0437462    -1.16   0.246     .8658991    1.037615
1.chronic_respiratory_disease |   1.857623   .0885893    12.99   0.000     1.691859    2.039628
                              |
                    asthmacat |
                 Yes, no OCS  |   1.075447   .0623987     1.25   0.210     .9598453    1.204971
                Yes with OCS  |   1.376514   .1355943     3.24   0.001     1.134835    1.669663
                              |
    1.chronic_cardiac_disease |   1.365807   .0576588     7.38   0.000     1.257347    1.483623
                              |
                      diabcat |
         Controlled diabetes  |   1.385242   .0670099     6.74   0.000     1.259939    1.523007
       Uncontrolled diabetes  |   2.328378   .1354133    14.53   0.000     2.077541    2.609501
  Diabetes, no hba1c measure  |    1.70748   .1739595     5.25   0.000      1.39841     2.08486
                              |
            cancer_exhaem_cat |
                   Last year  |    1.65636   .2244186     3.72   0.000     1.270066    2.160146
               2-5 years ago  |   1.343233   .1177872     3.37   0.001     1.131123    1.595117
                    5+ years  |   .9175753    .060151    -1.31   0.189     .8069411    1.043378
                              |
              cancer_haem_cat |
                   Last year  |    2.19938   .7352837     2.36   0.018     1.142172    4.235151
               2-5 years ago  |   3.491065   .5204451     8.39   0.000     2.606522    4.675783
                    5+ years  |   1.447491   .2285962     2.34   0.019     1.062158    1.972616
                              |
      1.chronic_liver_disease |   1.917575   .2563588     4.87   0.000     1.475557    2.492003
            1.stroke_dementia |   1.743794   .0896914    10.81   0.000     1.576573    1.928753
                1.other_neuro |   2.262115    .196741     9.39   0.000     1.907584    2.682535
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.489671   .0680726     8.72   0.000     1.362051    1.629248
           Stage 4/5 egfr<30  |   2.977666   .2255003    14.41   0.000      2.56693    3.454125
                              |
           1.organ_transplant |   2.554024   .6165812     3.88   0.000     1.591225    4.099381
                     1.spleen |   1.870592   .4855763     2.41   0.016     1.124658     3.11127
           1.ra_sle_psoriasis |   1.289397   .0822246     3.99   0.000     1.137904    1.461058
    1.other_immunosuppression |   2.599127   .6010165     4.13   0.000     1.651952     4.08938
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_sensan_earlieradmincensoring_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth, replace
file ./output/models/an_sensan_earlieradmincensoring_onscoviddeath_MAINFULLYADJMODEL_agespline_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. if e(N_fail)>0 estat phtest, d

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      age1        |      0.00330         0.03        1         0.8642
      age2        |     -0.00526         0.07        1         0.7852
      age3        |      0.00680         0.12        1         0.7242
      0b.male     |            .            .        1             .
      1.male      |     -0.00275         0.02        1         0.8828
      1b.obese4cat|            .            .        1             .
      2.obese4cat |      0.00589         0.10        1         0.7553
      3.obese4cat |      0.01718         0.82        1         0.3649
      4.obese4cat |      0.01007         0.28        1         0.5964
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|      0.02231         1.40        1         0.2375
      3.smoke_no~s|      0.01731         0.85        1         0.3561
      1b.imd      |            .            .        1             .
      2.imd       |      0.00495         0.07        1         0.7933
      3.imd       |      0.00176         0.01        1         0.9263
      4.imd       |      0.01558         0.67        1         0.4135
      5.imd       |      0.01547         0.65        1         0.4189
      0b.htdiag_~p|            .            .        1             .
      1.htdiag_o~p|     -0.00440         0.06        1         0.8097
      0b.c~respi~e|            .            .        1             .
      1.c~respir~e|     -0.02100         1.32        1         0.2512
      1b.asthmacat|            .            .        1             .
      2.asthmacat |     -0.00540         0.08        1         0.7740
      3.asthmacat |      0.00769         0.17        1         0.6800
      0b.c~cardi~e|            .            .        1             .
      1.c~cardia~e|     -0.03938         4.62        1         0.0316
      1b.diabcat  |            .            .        1             .
      2.diabcat   |     -0.01388         0.56        1         0.4541
      3.diabcat   |     -0.01671         0.81        1         0.3677
      4.diabcat   |     -0.00015         0.00        1         0.9935
      1b.c~exhae~t|            .            .        1             .
      2.cancer_e~t|     -0.04527         5.78        1         0.0162
      3.cancer_e~t|     -0.01818         0.94        1         0.3329
      4.cancer_e~t|     -0.00840         0.20        1         0.6549
      1b.cancer_h~|            .            .        1             .
      2.cancer_h~t|     -0.00523         0.08        1         0.7811
      3.cancer_h~t|      0.00691         0.14        1         0.7131
      4.cancer_h~t|     -0.01078         0.33        1         0.5661
      0b.c~liver~e|            .            .        1             .
      1.c~liver_~e|      0.00827         0.20        1         0.6532
      0b.stroke_~a|            .            .        1             .
      1.stroke_d~a|      0.04333         5.60        1         0.0180
      0b.other_n~o|            .            .        1             .
      1.other_ne~o|     -0.00678         0.13        1         0.7138
      1b.reduced~t|            .            .        1             .
      2.reduced_~t|     -0.01103         0.38        1         0.5395
      3.reduced_~t|     -0.01578         0.78        1         0.3760
      0b.organ_t~t|            .            .        1             .
      1.organ_tr~t|      0.00848         0.21        1         0.6480
      0b.spleen   |            .            .        1             .
      1.spleen    |      0.00449         0.06        1         0.8112
      0b.ra_sle_~s|            .            .        1             .
      1.ra_sle_p~s|     -0.01478         0.62        1         0.4320
      0b.other_i~n|            .            .        1             .
      1.other_im~n|      0.00531         0.08        1         0.7780
      ------------+---------------------------------------------------
      global test |                     27.88       36         0.8313
      ----------------------------------------------------------------
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"

. 
.  
. *Age group model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup") bp("i.htdiag_or_highbp") ethnicity(0)
   1:   2751.28 /        1 =    2751.2800

. if _rc==0{
. estimates

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,277,935                  Number of obs    =  17,277,935
No. of failures =        2,816
Time at risk    =   1122020325
                                                LR chi2(38)      =     9311.62
Log likelihood  =   -33237.748                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |   .0722108    .018045   -10.52   0.000     .0442479    .1178451
                      40-<50  |   .3278468    .056107    -6.52   0.000     .2344218    .4585046
                      60-<70  |   2.546897   .2463323     9.67   0.000     2.107097    3.078495
                      70-<80  |   5.837537   .5314754    19.38   0.000     4.883514    6.977933
                         80+  |   14.66236   1.356129    29.03   0.000     12.23139    17.57648
                              |
                       1.male |   1.801573    .072844    14.56   0.000     1.664312    1.950155
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.215175   .0594447     3.98   0.000     1.104077    1.337453
          Obese II (35-39.9)  |   1.439404   .1041725     5.03   0.000     1.249049    1.658769
             Obese III (40+)  |   2.421604   .2154877     9.94   0.000     2.034035     2.88302
                              |
                 smoke_nomiss |
                      Former  |   1.277548   .0557807     5.61   0.000     1.172767    1.391691
                     Current  |   .8780189   .0713035    -1.60   0.109     .7488213    1.029507
                              |
                          imd |
                           2  |   .9603215   .0599297    -0.65   0.516     .8497607    1.085267
                           3  |   .9960013   .0622427    -0.06   0.949      .881183    1.125781
                           4  |   1.254153   .0761998     3.73   0.000     1.113354    1.412758
             5 most deprived  |   1.404646   .0891108     5.36   0.000     1.240414    1.590623
                              |
           1.htdiag_or_highbp |   .9788267   .0453023    -0.46   0.644     .8939439    1.071769
1.chronic_respiratory_disease |   1.848786    .088364    12.86   0.000      1.68346    2.030348
                              |
                    asthmacat |
                 Yes, no OCS  |   1.056896   .0613038     0.95   0.340     .9433208    1.184145
                Yes with OCS  |   1.346648   .1326116     3.02   0.003     1.110278     1.63334
                              |
    1.chronic_cardiac_disease |   1.409837   .0596942     8.11   0.000     1.297562    1.531828
                              |
                      diabcat |
         Controlled diabetes  |   1.358993   .0658811     6.33   0.000     1.235813    1.494451
       Uncontrolled diabetes  |   2.216987   .1290327    13.68   0.000     1.977979    2.484875
  Diabetes, no hba1c measure  |   1.751738   .1785481     5.50   0.000     1.434529     2.13909
                              |
            cancer_exhaem_cat |
                   Last year  |   1.641911   .2224679     3.66   0.000     1.258976     2.14132
               2-5 years ago  |   1.330773   .1167375     3.26   0.001      1.12056    1.580421
                    5+ years  |   .9341503   .0612775    -1.04   0.299     .8214488    1.062314
                              |
              cancer_haem_cat |
                   Last year  |   2.143806   .7166935     2.28   0.023     1.113323    4.128096
               2-5 years ago  |   3.376759   .5034439     8.16   0.000     2.521121     4.52279
                    5+ years  |   1.430109   .2258694     2.27   0.024     1.049377    1.948977
                              |
      1.chronic_liver_disease |   1.857688   .2479893     4.64   0.000     1.430022    2.413252
            1.stroke_dementia |   1.829307   .0940674    11.74   0.000     1.653924    2.023286
                1.other_neuro |   2.210864   .1924254     9.12   0.000     1.864132     2.62209
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.655848   .0746903    11.18   0.000     1.515742    1.808904
           Stage 4/5 egfr<30  |   3.491631   .2619713    16.67   0.000     3.014144    4.044758
                              |
           1.organ_transplant |   2.266089   .5466738     3.39   0.001     1.412317    3.635982
                     1.spleen |   1.829337   .4748175     2.33   0.020     1.099913     3.04249
           1.ra_sle_psoriasis |   1.268645    .080891     3.73   0.000     1.119608    1.437521
    1.other_immunosuppression |    2.46118   .5689669     3.90   0.000     1.564464    3.871873
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_sensan_earlieradmincensoring_`outcome'_MAINFULLYADJMODEL_agegroup_bmicat_noeth, replace
file ./output/models/an_sensan_earlieradmincensoring_onscoviddeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING GROUP MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3") bp("i.htdiag_or_highbp") ethnicity(1)
   1:   3619.07 /        1 =    3619.0680

. if _rc==0{
. estimates

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   12,717,951                  Number of obs    =  12,717,951
No. of failures =        2,105
Time at risk    =    825933594
                                                LR chi2(40)      =     7241.03
Log likelihood  =    -24161.02                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.109272   .0441465     2.61   0.009     1.026035    1.199262
                         age2 |   1.020217   .0905252     0.23   0.822     .8573624    1.214006
                         age3 |   .9074979   .1887027    -0.47   0.641     .6037387    1.364087
                       1.male |   1.791596   .0840351    12.43   0.000     1.634234     1.96411
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.308319   .0737064     4.77   0.000     1.171547    1.461058
          Obese II (35-39.9)  |   1.549658     .13036     5.21   0.000     1.314109    1.827429
             Obese III (40+)  |   2.762721   .2829361     9.92   0.000     2.260288    3.376839
                              |
                 smoke_nomiss |
                      Former  |    1.34165   .0693525     5.69   0.000     1.212381    1.484703
                     Current  |   .9915212   .0929801    -0.09   0.928     .8250503    1.191581
                              |
                    ethnicity |
                       Mixed  |   1.012175   .2736738     0.04   0.964     .5958075    1.719511
      Asian or Asian British  |   1.626438   .1336075     5.92   0.000     1.384566    1.910564
                       Black  |   1.755023   .1973329     5.00   0.000     1.407909    2.187716
                       Other  |   1.840526   .2747496     4.09   0.000     1.373651    2.466082
                              |
                          imd |
                           2  |   1.008342   .0744858     0.11   0.910     .8724284    1.165429
                           3  |   .9541651   .0715316    -0.63   0.531     .8237793    1.105188
                           4  |   1.223694   .0880403     2.81   0.005     1.062752    1.409009
             5 most deprived  |   1.321428   .0988834     3.72   0.000     1.141163     1.53017
                              |
           1.htdiag_or_highbp |    .964161   .0521976    -0.67   0.500     .8670964    1.072091
1.chronic_respiratory_disease |   1.899842   .1036075    11.77   0.000     1.707251    2.114159
                              |
                    asthmacat |
                 Yes, no OCS  |   .9805157   .0666489    -0.29   0.772      .858214    1.120246
                Yes with OCS  |   1.479848   .1562552     3.71   0.000     1.203206    1.820097
                              |
    1.chronic_cardiac_disease |   1.447873   .0705889     7.59   0.000     1.315926     1.59305
                              |
                      diabcat |
         Controlled diabetes  |   1.319408   .0740247     4.94   0.000     1.182015    1.472772
       Uncontrolled diabetes  |   2.128973   .1444379    11.14   0.000     1.863895    2.431751
  Diabetes, no hba1c measure  |   1.699462   .1941036     4.64   0.000     1.358601    2.125844
                              |
            cancer_exhaem_cat |
                   Last year  |   1.643025   .2602258     3.14   0.002     1.204562     2.24109
               2-5 years ago  |   1.363285   .1389527     3.04   0.002     1.116421    1.664736
                    5+ years  |   .9643347   .0726371    -0.48   0.630     .8319789    1.117746
                              |
              cancer_haem_cat |
                   Last year  |    2.56162   .9088912     2.65   0.008     1.277906    5.134882
               2-5 years ago  |   3.752768   .6247129     7.94   0.000     2.708036    5.200545
                    5+ years  |   1.449125   .2633963     2.04   0.041     1.014821    2.069294
                              |
      1.chronic_liver_disease |   1.919388   .2877055     4.35   0.000     1.430779    2.574857
            1.stroke_dementia |   1.717904   .1023056     9.09   0.000     1.528648     1.93059
                1.other_neuro |   2.064658    .215351     6.95   0.000     1.682926    2.532978
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |      1.543    .081936     8.17   0.000     1.390483    1.712246
           Stage 4/5 egfr<30  |    3.03719   .2641386    12.77   0.000     2.561206    3.601632
                              |
           1.organ_transplant |   2.424256     .66416     3.23   0.001     1.417031    4.147414
                     1.spleen |   2.087874   .5826291     2.64   0.008     1.208295     3.60774
           1.ra_sle_psoriasis |   1.296115   .0951474     3.53   0.000     1.122424    1.496683
    1.other_immunosuppression |   2.908732   .6937385     4.48   0.000     1.822596    4.642127
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_sensan_earlieradmincensoring_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCeth, replace
file ./output/models/an_sensan_earlieradmincensoring_onscoviddeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL DID NOT FIT (OUTCOME `outcome')"

.  
.  log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_sensan_earlieradmincensoring_onscoviddeath.log
  log type:  text
 closed on:   7 Jul 2020, 04:00:31
----------------------------------------------------------------------------------------------------------------------------------
