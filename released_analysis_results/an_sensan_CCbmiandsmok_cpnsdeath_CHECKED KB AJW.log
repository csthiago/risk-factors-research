-------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-3\analysis\output/an_sensan_CCbmiandsmok_cpnsdeath.log
  log type:  text
 opened on:  12 May 2020, 19:40:51

. 
. use "cr_create_analysis_dataset_STSET_cpnsdeath.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. ******************************
. drop if bmicat>=. | smoke>=.
(3,831,320 observations deleted)

. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.reduced_kidney_function_cat   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  bp("i.htdiag_or_highbp") ethnicity(0)
   1:   2354.60 /        1 =    2354.6020

. if _rc==0{
. estimates

-------------------------------------------------------------------------------------------------------
active results
-------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   13,451,561                  Number of obs    =  13,451,561
No. of failures =        5,140
Time at risk    =   1128316574
                                                LR chi2(36)      =    15892.19
Log likelihood  =    -59878.92                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.116017   .0319218     3.84   0.000     1.055172    1.180369
                         age2 |   .9891569   .0621963    -0.17   0.862     .8744667    1.118889
                         age3 |   .9904335   .1449938    -0.07   0.948     .7433858    1.319582
                       1.male |   2.056819   .0624567    23.75   0.000     1.937978    2.182949
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.314926   .0462749     7.78   0.000     1.227286    1.408824
          Obese II (35-39.9)  |   1.630425   .0836278     9.53   0.000     1.474487    1.802854
             Obese III (40+)  |   2.374685   .1602774    12.81   0.000     2.080439    2.710549
                              |
                 smoke_nomiss |
                      Former  |   1.240335   .0403404     6.62   0.000     1.163736    1.321975
                     Current  |    .912137   .0555243    -1.51   0.131     .8095526    1.027721
                              |
                          imd |
                           2  |   1.118358   .0531711     2.35   0.019     1.018852    1.227581
                           3  |   1.231428   .0580072     4.42   0.000     1.122826    1.350534
                           4  |    1.47404   .0684474     8.36   0.000     1.345809    1.614488
             5 most deprived  |    1.71395   .0815974    11.32   0.000     1.561256    1.881577
                              |
           1.htdiag_or_highbp |   .9297487   .0319463    -2.12   0.034     .8691969    .9945188
1.chronic_respiratory_disease |   1.741481   .0612468    15.77   0.000     1.625483    1.865757
                              |
                    asthmacat |
                 Yes, no OCS  |   1.103907   .0465137     2.35   0.019     1.016405    1.198943
                Yes with OCS  |   1.225219   .0933114     2.67   0.008     1.055328    1.422461
                              |
    1.chronic_cardiac_disease |   1.244691   .0386782     7.04   0.000     1.171145    1.322855
                              |
                      diabcat |
         Controlled diabetes  |    1.45029   .0507944    10.61   0.000     1.354075    1.553342
       Uncontrolled diabetes  |   2.206912   .0944299    18.50   0.000     2.029381    2.399973
  Diabetes, no hba1c measure  |   1.801868   .1347607     7.87   0.000     1.556188    2.086334
                              |
            cancer_exhaem_cat |
                   Last year  |    1.52085   .1564773     4.08   0.000     1.243105    1.860651
               2-5 years ago  |   1.193025   .0807217     2.61   0.009     1.044855    1.362207
                    5+ years  |    .950614   .0449427    -1.07   0.284     .8664859     1.04291
                              |
              cancer_haem_cat |
                   Last year  |     3.5941   .6947378     6.62   0.000      2.46067    5.249609
               2-5 years ago  |    2.98432   .3549447     9.19   0.000     2.363776    3.767769
                    5+ years  |   1.875731   .1949517     6.05   0.000     1.530037     2.29953
                              |
      1.chronic_liver_disease |   1.599885   .1618035     4.65   0.000     1.312209    1.950628
            1.stroke_dementia |   1.771045   .0673714    15.03   0.000     1.643802    1.908138
                1.other_neuro |   2.391531   .1497847    13.92   0.000     2.115262    2.703883
                              |
  reduced_kidney_function_cat |
    Stage 3a/3b egfr 30-60    |   1.542462   .0521737    12.81   0.000     1.443519    1.648186
           Stage 4/5 egfr<30  |    3.41178     .18373    22.79   0.000     3.070029    3.791575
                              |
           1.organ_transplant |   3.791147    .570235     8.86   0.000     2.823186    5.090984
                     1.spleen |   1.246718   .2871774     0.96   0.338     .7937739    1.958122
           1.ra_sle_psoriasis |   1.201106   .0578949     3.80   0.000     1.092829    1.320111
    1.other_immunosuppression |   1.610341   .2707544     2.83   0.005     1.158247    2.238899
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_sensan_CCbmiandsmok_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_no
> eth, replace
file ./output/models/an_sensan_CCbmiandsmok_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_noeth.ster sav
> ed
. *estat concordance /*c-statistic*/
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"

.  
. *Age group model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup") bp("i.htdiag_or_highbp") ethnicity(0)
   1:   2412.35 /        1 =    2412.3500

. if _rc==0{
. estimates

-------------------------------------------------------------------------------------------------------
active results
-------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   13,451,561                  Number of obs    =  13,451,561
No. of failures =        5,140
Time at risk    =   1128316574
                                                LR chi2(38)      =    15425.96
Log likelihood  =   -60112.037                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |   .0858553   .0162528   -12.97   0.000     .0592421    .1244238
                      40-<50  |   .3144203   .0406633    -8.95   0.000     .2440205    .4051303
                      60-<70  |   2.144121   .1515084    10.79   0.000     1.866816    2.462618
                      70-<80  |    4.94299   .3256848    24.25   0.000     4.344158     5.62437
                         80+  |    12.8448   .8618677    38.05   0.000     11.26193    14.65014
                              |
                       1.male |   1.961249   .0592404    22.30   0.000      1.84851    2.080864
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.235277   .0432073     6.04   0.000      1.15343    1.322932
          Obese II (35-39.9)  |   1.496898   .0763481     7.91   0.000     1.354495    1.654273
             Obese III (40+)  |   2.137311   .1435197    11.31   0.000     1.873742    2.437955
                              |
                 smoke_nomiss |
                      Former  |   1.247703   .0406224     6.80   0.000     1.170571    1.329916
                     Current  |   .8629753   .0523861    -2.43   0.015     .7661732    .9720077
                              |
                          imd |
                           2  |   1.119524   .0532267     2.37   0.018     1.019914    1.228861
                           3  |   1.232893   .0580892     4.44   0.000     1.124139    1.352168
                           4  |   1.473008   .0684418     8.34   0.000     1.344791    1.613449
             5 most deprived  |   1.704455   .0811864    11.20   0.000     1.552534    1.871242
                              |
           1.htdiag_or_highbp |   .9623454   .0331575    -1.11   0.265     .8995036    1.029577
1.chronic_respiratory_disease |    1.73682   .0612144    15.66   0.000     1.620892    1.861039
                              |
                    asthmacat |
                 Yes, no OCS  |   1.085086   .0457092     1.94   0.053      .999096    1.178476
                Yes with OCS  |   1.199041   .0912912     2.38   0.017     1.032824    1.392009
                              |
    1.chronic_cardiac_disease |   1.284619   .0400289     8.04   0.000     1.208511    1.365519
                              |
                      diabcat |
         Controlled diabetes  |   1.428622   .0501643    10.16   0.000     1.333609    1.530404
       Uncontrolled diabetes  |   2.115468   .0906149    17.49   0.000     1.945117    2.300738
  Diabetes, no hba1c measure  |   1.844832   .1380374     8.18   0.000     1.593186    2.136225
                              |
            cancer_exhaem_cat |
                   Last year  |   1.514553   .1558294     4.03   0.000     1.237958    1.852946
               2-5 years ago  |   1.184549   .0801769     2.50   0.012     1.037383    1.352593
                    5+ years  |   .9673719   .0457653    -0.70   0.483     .8817064     1.06136
                              |
              cancer_haem_cat |
                   Last year  |    3.52726   .6817717     6.52   0.000      2.41497     5.15185
               2-5 years ago  |   2.890179   .3437843     8.92   0.000     2.289154    3.649005
                    5+ years  |   1.854752   .1927923     5.94   0.000     1.512891    2.273861
                              |
      1.chronic_liver_disease |   1.557572   .1572509     4.39   0.000     1.277943    1.898386
            1.stroke_dementia |   1.847606   .0702844    16.14   0.000     1.714861    1.990626
                1.other_neuro |   2.341921   .1467785    13.58   0.000     2.071208    2.648017
                              |
  reduced_kidney_function_cat |
    Stage 3a/3b egfr 30-60    |   1.703949   .0568616    15.97   0.000     1.596069    1.819121
           Stage 4/5 egfr<30  |    3.98015   .2119551    25.94   0.000     3.585671    4.418029
                              |
           1.organ_transplant |   3.377009   .5074343     8.10   0.000     2.515529    4.533514
                     1.spleen |   1.217952   .2805254     0.86   0.392      .775491    1.912862
           1.ra_sle_psoriasis |    1.18293   .0570108     3.49   0.000     1.076306    1.300116
    1.other_immunosuppression |   1.527444   .2567019     2.52   0.012     1.098785    2.123333
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_sensan_CCbmiandsmok_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noe
> th, replace
file ./output/models/an_sensan_CCbmiandsmok_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster save
> d
. *estat concordance /*c-statistic*/
. }

. else di "WARNING GROUP MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3") bp("i.htdiag_or_highbp") ethnicity(1)
   1:   1924.88 /        1 =    1924.8760

. if _rc==0{
. estimates

-------------------------------------------------------------------------------------------------------
active results
-------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   10,718,701                  Number of obs    =  10,718,701
No. of failures =        3,914
Time at risk    =    899194744
                                                LR chi2(40)      =    12473.77
Log likelihood  =   -44677.086                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.101031   .0349634     3.03   0.002     1.034593    1.171736
                         age2 |    1.02947   .0720829     0.41   0.678     .8974554    1.180903
                         age3 |   .8950665   .1461188    -0.68   0.497     .6499761    1.232575
                       1.male |   1.980327   .0687646    19.68   0.000     1.850035    2.119796
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.337979   .0538618     7.23   0.000      1.23647    1.447823
          Obese II (35-39.9)  |   1.686324   .0984511     8.95   0.000     1.503994    1.890758
             Obese III (40+)  |   2.415151   .1879497    11.33   0.000     2.073494    2.813103
                              |
                 smoke_nomiss |
                      Former  |   1.315786   .0500259     7.22   0.000     1.221301     1.41758
                     Current  |   .9689379   .0672625    -0.45   0.649     .8456809    1.110159
                              |
                    ethnicity |
                       Mixed  |   1.554498   .2705616     2.53   0.011     1.105192    2.186465
      Asian or Asian British  |   1.671535    .105021     8.18   0.000     1.477867    1.890582
                       Black  |   1.662693   .1499838     5.64   0.000      1.39325    1.984243
                       Other  |   1.394499   .1915514     2.42   0.015     1.065357    1.825329
                              |
                          imd |
                           2  |   1.159789    .065271     2.63   0.008     1.038663     1.29504
                           3  |   1.238686   .0691852     3.83   0.000     1.110245    1.381988
                           4  |   1.498621   .0818066     7.41   0.000     1.346563    1.667851
             5 most deprived  |    1.66815   .0934015     9.14   0.000     1.494774    1.861636
                              |
           1.htdiag_or_highbp |   .9515809   .0378139    -1.25   0.212     .8802798    1.028657
1.chronic_respiratory_disease |   1.757821   .0706897    14.03   0.000     1.624591    1.901976
                              |
                    asthmacat |
                 Yes, no OCS  |   1.025165   .0500892     0.51   0.611     .9315462    1.128193
                Yes with OCS  |   1.204045   .1023705     2.18   0.029     1.019229    1.422374
                              |
    1.chronic_cardiac_disease |   1.248596   .0447159     6.20   0.000      1.16396    1.339387
                              |
                      diabcat |
         Controlled diabetes  |    1.43001   .0578525     8.84   0.000     1.321001    1.548016
       Uncontrolled diabetes  |   2.102458   .1041725    15.00   0.000     1.907884    2.316875
  Diabetes, no hba1c measure  |   1.851421   .1541231     7.40   0.000     1.572701    2.179536
                              |
            cancer_exhaem_cat |
                   Last year  |   1.689202   .1916749     4.62   0.000     1.352369     2.10993
               2-5 years ago  |   1.223297   .0953458     2.59   0.010     1.049997    1.425201
                    5+ years  |   1.014894   .0545399     0.28   0.783     .9134351    1.127623
                              |
              cancer_haem_cat |
                   Last year  |   3.250273   .7489404     5.12   0.000     2.069106     5.10572
               2-5 years ago  |   3.201432   .4245508     8.77   0.000     2.468676    4.151686
                    5+ years  |   1.823719   .2207838     4.96   0.000     1.438498    2.312099
                              |
      1.chronic_liver_disease |    1.63746   .1836907     4.40   0.000     1.314265    2.040134
            1.stroke_dementia |   1.729651   .0762483    12.43   0.000     1.586482    1.885741
                1.other_neuro |   2.395663   .1720654    12.16   0.000     2.081083    2.757797
                              |
  reduced_kidney_function_cat |
    Stage 3a/3b egfr 30-60    |   1.600874    .062319    12.09   0.000     1.483275    1.727798
           Stage 4/5 egfr<30  |   3.401094   .2113631    19.70   0.000     3.011065    3.841644
                              |
           1.organ_transplant |    4.01002   .6559446     8.49   0.000     2.910114    5.525645
                     1.spleen |   1.262175   .3272553     0.90   0.369     .7593137    2.098061
           1.ra_sle_psoriasis |   1.132717   .0642006     2.20   0.028     1.013624    1.265803
    1.other_immunosuppression |   1.708455   .3054181     3.00   0.003      1.20347    2.425334
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_sensan_CCbmiandsmok_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CC
> eth, replace
file ./output/models/an_sensan_CCbmiandsmok_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster sav
> ed
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL WITH AGESPLINE DID NOT FIT (OUTCOME `outcome')"

.  
.  log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-3\analysis\output/an_sensan_CCbmiandsmok_cpnsdeath.log
  log type:  text
 closed on:  12 May 2020, 21:33:03
-------------------------------------------------------------------------------------------------------
