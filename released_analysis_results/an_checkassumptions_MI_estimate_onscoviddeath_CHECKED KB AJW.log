----------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_checkassumptions_MI_estimate_onscoviddeath.log
  log type:  text
 opened on:   7 Jul 2020, 05:59:25

. 
. 
. 
. ********************************   NOTES  **************************************
. 
. *  Assumes region is string, taking  values: 
. *    East, East Midlands, London, North East, North West, South East, 
. *    South West, West Midlands, and Yorkshire and The Humber
. *
. *  Assumes ethnicity is numeric, taking values: 
. *       1, 2, 3, 4, 5, (missing: . or .u)
. *       in the order White, Black, Asian, Mixed, Other
. *       with value labels exactly as above. 
. *       (NB: this is now intially recoded from ordering: 
. *      White, Mixed, Asian, Black, Other)       
. *
. *
. *  Assumes a complete case sample other than ethnicity
. *
. ********************************************************************************
. 
. 
. 
. * Add imputations to the full dataset
. use cr_create_analysis_dataset.dta, clear
(Analysis dataset for the poor outcomes in Covid project)

. merge 1:1 patient_id using imputed_`outcome'.dta
(label ethnicity already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                           696
        from master                       696  (_merge==1)
        from using                          0  (_merge==2)

    matched                        17,277,696  (_merge==3)
    -----------------------------------------

. 
. 
. 
. /*   Prepare data to be imported   */
. 
. 
. * Create ID version for exportation into Stata mi impute
. gen _mi = _n

. 
. * Change imputed ethnicity to the original coding (switch mixed and black)
. label define ethnicity  1 "White"                                       ///
>                                                 2 "Mixed"                                       ///
>                                                 3 "Asian or Asian British"      ///
>                                                 4 "Black"                                       ///
>                                                 5 "Other"                                       ///
>                                                 .u "Unknown", replace

. label values ethnicity ethnicity

. 
. forvalues i = 1 (1) 5 {
  2.         recode ethnicity`i' 2=4 4=2
  3.         label values ethnicity`i' ethnicity
  4. }
(ethnicity1: 685282 changes made)
(ethnicity2: 708927 changes made)
(ethnicity3: 693919 changes made)
(ethnicity4: 713740 changes made)
(ethnicity5: 713294 changes made)

. 
. 
. recode ethnicity .u=.
(ethnicity: 4560113 changes made)

. 
. /*  Import into -mi- format  */
. 
. 
. mi import wide, imputed(ethnicity = ///
>                                                 ethnicity1  ///
>                                                 ethnicity2      ///
>                                                 ethnicity3      ///
>                                                 ethnicity4      ///
>                                                 ethnicity5) drop clear
(2470 values of imputed variable ethnicity in m>0 updated to match values in m=0)

. 
. 
. 
. 
. 
. **************************
. *  Analyse imputed data  *
. **************************
. 
. 
. // Declare imputed data as survival
. 
. mi stset stime_`outcome', fail(`outcome') enter(enter_date)     ///
>         origin(enter_date) id(patient_id)

                id:  patient_id
     failure event:  onscoviddeath != 0 & onscoviddeath < .
obs. time interval:  (stime_onscoviddeath[_n-1], stime_onscoviddeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17278392  total observations
        457  observations end on or before enter()
------------------------------------------------------------------------------
   17277935  observations remaining, representing
   17277935  subjects
     10,926  failures in single-failure-per-subject data
 1.6389e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        95

. 
.         
. // Check if the MI distribution of ethnicity matches that in the external data
. mi estimate: prop ethnicity 

Multiple-imputation estimates     Imputations     =          5
Proportion estimation             Number of obs   = 17,278,190
                                  Average RVI     =   315.0842
                                  Largest FMI     =     0.9982
                                  Complete DF     =   17278189
DF adjustment:   Small sample     DF:     min     =       4.02
                                          avg     =       4.03
Within VCE type:     Analytic             max     =       4.06

-------------------------------------------------------------------------
                        |                                   Normal
                        | Proportion   Std. Err.     [95% Conf. Interval]
------------------------+------------------------------------------------
              ethnicity |
                 White  |   .8605489   .0010037      .8577771    .8633206
                 Mixed  |   .0140364   .0003642        .01303    .0150428
Asian or Asian British  |   .0770154   .0012083      .0736678    .0803629
                 Black  |   .0266535   .0007532      .0245665    .0287406
                 Other  |   .0217458   .0006965      .0198158    .0236758
-------------------------------------------------------------------------

. tab ethnicity

             Ethnicity |      Freq.     Percent        Cum.
-----------------------+-----------------------------------
                 White | 10,866,411       85.44       85.44
                 Mixed |    169,697        1.33       86.77
Asian or Asian British |  1,022,130        8.04       94.81
                 Black |    339,909        2.67       97.48
                 Other |    320,132        2.52      100.00
-----------------------+-----------------------------------
                 Total | 12,718,279      100.00

. 
. 
. 
. * Primary analysis using imputed data
. mi estimate, eform:                                                     ///
>         stcox   i.ethnicity                                                     ///
>                         age1 age2 age3                                          ///
>                         i.male                                                          ///
>                         i.obese4cat                                                     ///
>                         i.smoke_nomiss                                          ///
>                         i.imd                                                           ///
>                         i.htdiag_or_highbp                                      ///
>                         i.chronic_respiratory_disease           ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease                       ///
>                         i.diabcat                                                       ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                                       ///
>                         i.chronic_liver_disease                         ///
>                         i.stroke_dementia                                       ///
>                         i.other_neuro                                           ///
>                         i.reduced_kidney_function_cat           ///
>                         i.organ_transplant                                      ///
>                         i.spleen                                                        ///
>                         i.ra_sle_psoriasis                              ///
>                         i.other_immunosuppression                       ///
>                         , strata(stp)
