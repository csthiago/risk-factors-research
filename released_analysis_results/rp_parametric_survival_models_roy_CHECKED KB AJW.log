-------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/rp_parametric_survival_m
> odels_roy.log
  log type:  text
 opened on:  15 May 2020, 01:11:28

. 
. use "cr_create_analysis_dataset_STSET_cpnsdeath.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. ********************************************
. *   Comorbidity counts for assessing risk  *
. ********************************************
. 
. * Create absent/present for categorical comorbidities
. recode asthma 1=0 2/3=1, gen(asthmabin)
(2747068 differences between asthma and asthmabin)

. recode diabcat 1=0 2/4=1, gen(diabbin)
(17283279 differences between diabcat and diabbin)

. recode cancer_exhaem_cat 1=0 2/4=1, gen(cancer_exhaem_bin)
(17283279 differences between cancer_exhaem_cat and cancer_exhaem_bin)

. recode cancer_haem_cat 1=0 2/4=1, gen(cancer_haem_bin)
(17283279 differences between cancer_haem_cat and cancer_haem_bin)

. recode reduced_kidney_function_cat 1=0 2/3=1, gen(kidneybin)
(17283279 differences between reduced_kidney_function_cat and kidneybin)

. 
. * Count comorbidities present
. egen comorbidity_count = rowtotal(                      ///
>                         htdiag_or_highbp                                ///
>                         chronic_respiratory_disease     ///
>                         asthmabin                                               ///
>                         chronic_cardiac_disease                 ///
>                         diabbin                                                 ///
>                         cancer_exhaem_bin                               ///
>                         cancer_haem_bin                                 ///
>                         chronic_liver_disease                   ///
>                         stroke_dementia                                 ///
>                         kidneybin                                               ///
>                         other_neuro                                             ///
>                         organ_transplant                                ///
>                         spleen                                                  ///
>                         ra_sle_psoriasis                                ///
>                         other_immunosuppression                 ///
>                         )

. drop asthmabin diabbin cancer_exhaem_bin cancer_haem_bin kidneybin

. 
. recode comorbidity_count 1/max=1 0=0, gen(comorbidity_any)
(3362133 differences between comorbidity_count and comorbidity_any)

. 
. 
. * Create numerical region variable
. encode region, gen(region_new)

. drop region

. rename region_new region

. 
. 
. 
. 
. 
. *********************
. *   Royston-Parmar  *
. *********************
. 
. * Create dummy variables for categorical predictors 
. foreach var of varlist obese4cat smoke_nomiss imd               ///
>         asthmacat diabcat cancer_exhaem_cat cancer_haem_cat ///
>         reduced_kidney_function_cat     region                                  ///
>         {
  2.                 egen ord_`var' = group(`var')
  3.                 qui summ ord_`var'
  4.                 local max=r(max)
  5.                 forvalues i = 1 (1) `max' {
  6.                         gen `var'_`i' = (`var'==`i')
  7.                 }       
  8.                 drop ord_`var'
  9.                 drop `var'_1
 10. }
(700 missing values generated)

. 
. timer clear 1

. timer on 1

. stpm2  age1 age2 age3 male                                      ///
>                         obese4cat_*                                             ///
>                         smoke_nomiss_*                                  ///
>                         imd_*                                                   ///
>                         htdiag_or_highbp                                ///
>                         chronic_respiratory_disease     ///
>                         asthmacat_*                                             ///
>                         chronic_cardiac_disease                 ///
>                         diabcat_*                                               ///
>                         cancer_exhaem_cat_*                             ///
>                         cancer_haem_cat_*                               ///
>                         chronic_liver_disease                   ///
>                         stroke_dementia                                 ///
>                         other_neuro                                             ///
>                         reduced_kidney_function_cat_*   ///
>                         organ_transplant                                ///
>                         spleen                                                  ///
>                         ra_sle_psoriasis                                ///
>                         other_immunosuppression                 ///
>                         region_*,                                               ///
>                         scale(hazard) df(5) eform

Iteration 0:   log likelihood = -37704.254  
Iteration 1:   log likelihood = -37665.308  
Iteration 2:   log likelihood = -37665.098  
Iteration 3:   log likelihood = -37665.098  

Log likelihood = -37665.098                     Number of obs     = 17,282,832

-----------------------------------------------------------------------------------------------
                              |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
xb                            |
                         age1 |   1.134577   .0275072     5.21   0.000     1.081925    1.189792
                         age2 |   .9549195   .0515874    -0.85   0.393     .8589789    1.061576
                         age3 |    1.06946   .1353739     0.53   0.596     .8344845    1.370601
                         male |   1.972881   .0567732    23.61   0.000     1.864687    2.087352
                  obese4cat_2 |   1.254163   .0434334     6.54   0.000      1.17186    1.342247
                  obese4cat_3 |   1.537401   .0781811     8.46   0.000     1.391558     1.69853
                  obese4cat_4 |   2.223023   .1490576    11.91   0.000     1.949259    2.535237
               smoke_nomiss_2 |   1.228568   .0377751     6.69   0.000     1.156717    1.304882
               smoke_nomiss_3 |   .8711564   .0504514    -2.38   0.017     .7776791    .9758697
                        imd_2 |   1.099018    .049455     2.10   0.036     1.006239    1.200351
                        imd_3 |   1.150166   .0512911     3.14   0.002     1.053906    1.255219
                        imd_4 |   1.395725    .061108     7.62   0.000      1.28095    1.520783
                        imd_5 |   1.634547   .0727822    11.04   0.000     1.497944    1.783607
             htdiag_or_highbp |   .9418832   .0305271    -1.85   0.065      .883912    1.003656
  chronic_respiratory_disease |   1.795118   .0610311    17.21   0.000     1.679398    1.918812
                  asthmacat_2 |   1.110715    .045212     2.58   0.010     1.025544    1.202959
                  asthmacat_3 |   1.251617   .0919593     3.05   0.002     1.083756    1.445477
      chronic_cardiac_disease |   1.241898   .0372795     7.22   0.000      1.17094    1.317157
                    diabcat_2 |   1.519099   .0515286    12.33   0.000     1.421388    1.623526
                    diabcat_3 |     2.2889   .0953728    19.87   0.000     2.109402    2.483672
                    diabcat_4 |   1.914328   .1375464     9.04   0.000     1.662864     2.20382
          cancer_exhaem_cat_2 |   1.552808   .1528196     4.47   0.000     1.280403    1.883167
          cancer_exhaem_cat_3 |   1.172587   .0771305     2.42   0.016     1.030753    1.333937
          cancer_exhaem_cat_4 |   .9519328   .0431927    -1.09   0.278     .8709318    1.040467
            cancer_haem_cat_2 |    3.31726   .6410253     6.21   0.000     2.271401    4.844681
            cancer_haem_cat_3 |   3.034832    .344593     9.78   0.000     2.429316    3.791274
            cancer_haem_cat_4 |   1.846053    .185169     6.11   0.000     1.516576     2.24711
        chronic_liver_disease |   1.608392   .1566562     4.88   0.000     1.328879    1.946697
              stroke_dementia |   1.776438   .0649691    15.71   0.000     1.653558     1.90845
                  other_neuro |   2.458023   .1452226    15.22   0.000     2.189254    2.759789
reduced_kidney_function_cat_2 |   1.546444   .0500697    13.46   0.000     1.451359     1.64776
reduced_kidney_function_cat_3 |   3.456823    .178704    23.99   0.000      3.12373    3.825436
             organ_transplant |   3.655478   .5379023     8.81   0.000     2.739619     4.87751
                       spleen |   1.390907    .291343     1.58   0.115     .9225782    2.096974
             ra_sle_psoriasis |   1.233222   .0567468     4.56   0.000     1.126869    1.349613
      other_immunosuppression |   1.836106   .2792812     3.99   0.000      1.36278    2.473831
                     region_2 |   .7437239   .0314827    -6.99   0.000     .6845095    .8080609
                     region_3 |   1.672677    .089028     9.67   0.000     1.506978    1.856595
                     region_4 |   .7240281   .0498763    -4.69   0.000     .6325845    .8286905
                     region_5 |   .8368165   .0415568    -3.59   0.000      .759205    .9223621
                     region_6 |   .6608323    .041443    -6.61   0.000     .5843991    .7472622
                     region_7 |   .4045238   .0223976   -16.35   0.000     .3629234    .4508928
                     region_8 |   1.685467   .0919934     9.56   0.000     1.514472    1.875768
                     region_9 |   .7421506   .0337556    -6.56   0.000      .678854    .8113489
                        _rcs1 |   2.666235   .1558294    16.78   0.000     2.377659    2.989836
                        _rcs2 |    1.17959    .019533     9.97   0.000      1.14192    1.218502
                        _rcs3 |   1.004906    .001439     3.42   0.001      1.00209    1.007731
                        _rcs4 |   1.000023   .0001974     0.12   0.908     .9996361     1.00041
                        _rcs5 |   1.000069    .000049     1.41   0.160     .9999729    1.000165
                        _cons |   6.30e-08   5.50e-08   -18.97   0.000     1.13e-08    3.49e-07
-----------------------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

. estat ic

Akaike's information criterion and Bayesian information criterion

-----------------------------------------------------------------------------
       Model |          N   ll(null)  ll(model)      df        AIC        BIC
-------------+---------------------------------------------------------------
           . | 17,282,832          .   -37665.1      50    75430.2   76163.46
-----------------------------------------------------------------------------
Note: BIC uses N = number of observations. See [R] BIC note.

. timer off 1

. timer list 1
   1:   2846.98 /        1 =    2846.9840

. 
. 
. 
. 
. 
. *****************************************************
. *   Survival predictions from Royston-Parmar model  *
. *****************************************************
. 
. 
. * Survival at t
. predict surv_royp, surv

. 
. * Survival at 30 days
. gen told = _t
(447 missing values generated)

. replace _t = 30
(17,282,746 real changes made)

. predict surv30_royp, surv

. 
. * Survival at 60 days
. replace _t = 60
(17,283,279 real changes made)

. predict surv60_royp, surv

. 
. * Survival at 80 days
. replace _t = 60
(0 real changes made)

. predict surv80_royp, surv

. replace _t = told
(17,282,467 real changes made, 447 to missing)

. drop told

. 
. * Absolute risk at 30, 60 and 80 days
. gen risk_royp = 1-surv_royp
(447 missing values generated)

. gen risk30_royp = 1-surv30_royp
(447 missing values generated)

. gen risk60_royp = 1-surv60_royp
(447 missing values generated)

. gen risk80_royp = 1-surv80_royp
(447 missing values generated)

. 
. 
. 
. 
. /*  Quantiles of predicted 30, 60 and 80 day risk   */
. 
. centile risk30_royp, c(20 40 60 80)

                                                       -- Binom. Interp. --
    Variable |       Obs  Percentile    Centile        [95% Conf. Interval]
-------------+-------------------------------------------------------------
 risk30_royp |17,282,832         20    5.44e-06        5.42e-06    5.44e-06
             |                   40     .000022         .000022     .000022
             |                   60    .0000743        .0000742    .0000744
             |                   80    .0002825        .0002821     .000283

. centile risk60_royp, c(20 40 60 80)

                                                       -- Binom. Interp. --
    Variable |       Obs  Percentile    Centile        [95% Conf. Interval]
-------------+-------------------------------------------------------------
 risk60_royp |17,282,832         20    5.44e-06        5.42e-06    5.44e-06
             |                   40     .000022         .000022     .000022
             |                   60    .0000743        .0000742    .0000744
             |                   80    .0002825        .0002821     .000283

. centile risk80_royp, c(20 40 60 80)

                                                       -- Binom. Interp. --
    Variable |       Obs  Percentile    Centile        [95% Conf. Interval]
-------------+-------------------------------------------------------------
 risk80_royp |17,282,832         20    5.44e-06        5.42e-06    5.44e-06
             |                   40     .000022         .000022     .000022
             |                   60    .0000743        .0000742    .0000744
             |                   80    .0002825        .0002821     .000283

. 
. 
. 
. 
. *************************************
. *   Summarise risks by comorbidity  *
. *************************************
. 
. 
. /*  Post into dataset   */
. 
. tempname temprf 

. 
. postfile `temprf' str30(rf) rfcat sex age risk30 risk60 risk80  ///
>         using abs_risks_roy, replace
(note: file abs_risks_roy.dta not found)

. 
.         * Binary risk factors
.         foreach var of varlist                                          ///
>                                 htdiag_or_highbp                                ///
>                                 chronic_respiratory_disease     ///
>                                 chronic_cardiac_disease                 ///
>                                 chronic_liver_disease                   ///
>                                 stroke_dementia                                 ///
>                                 other_neuro                                             ///
>                                 organ_transplant                                ///
>                                 spleen                                                  ///
>                                 ra_sle_psoriasis                                ///
>                                 other_immunosuppression    {
  2.                                         
.                 forvalues i = 1 (1) 6 {
  3.                         forvalues j = 0 (1) 1 {
  4.                                 forvalues k = 0 (1) 1 {
  5. 
.                                         * Mean risk of event at 30 days among age and sex group
.                                         qui summ risk30 if  `var'==`k'
  6.                                         local r30 = r(mean)
  7.                                         
.                                         * Mean risk of event at 60 days among age and sex group
.                                         qui summ risk60 if  `var'==`k'
  8.                                         local r60 = r(mean)
  9.                                                                                 
.                                         * Mean risk of event at 80 days among age and sex group
.                                         qui summ risk80 if  `var'==`k' 
 10.                                         local r80 = r(mean)
 11.                                         
.                                         post `temprf'  ("`var'") (`k') (`j') (`i') (`r30') (`r60') (`
> r80')
 12.                                 }
 13.                         }
 14.                 }
 15.         }

. 
.         * Categorical risk factors
.         local max_obese4cat                     = 4

.         local max_smoke_nomiss                  = 3     

.         local max_imd                                   = 5     

.         local max_asthmacat                             = 3     

.         local max_diabcat                               = 4     

.         local max_cancer_exhaem_cat             = 4      

.         local max_cancer_haem_cat               = 4 

.         local max_reduced_kidney_function_cat = 3

.                                         
.         foreach var of varlist                                          ///
>                                 obese4cat                                               ///
>                                 smoke_nomiss                                    ///
>                                 imd                                                     ///
>                                 asthmacat                                               ///
>                                 diabcat                                                 ///
>                                 cancer_exhaem_cat                               ///
>                                 cancer_haem_cat                                 ///
>                                 reduced_kidney_function_cat    {
  2.                                         
.                 forvalues i = 1 (1) 6 {
  3.                         forvalues j = 0 (1) 1 { 
  4.                                 forvalues k = 1 (1) `max_`var'' {
  5.                                         
.                                         * Mean risk of event at 30 days among age and sex group
.                                         qui summ risk30 if  `var'==`k' 
  6.                                         local r30 = r(mean)
  7.                                         
.                                         * Mean risk of event at 60 days among age and sex group
.                                         qui summ risk60 if  `var'==`k' 
  8.                                         local r60 = r(mean)
  9.                                                                                 
.                                         * Mean risk of event at 80 days among age and sex group
.                                         qui summ risk80 if  `var'==`k'
 10.                                         local r80 = r(mean)
 11.                                         
.                                         
.                                         post `temprf'  ("`var'") (`k')  (`j') (`i') (`r30') (`r60') (
> `r80')
 12.                                 }
 13.                         }
 14.                 }
 15.         }

.         
.         
.         /*  Grouped comorbidity  */
.         
.         * Smoking with no other disease vs other disease 
.         forvalues i = 1 (1) 6 {
  2.                 forvalues j = 0 (1) 1 { 
  3.                         forvalues k = 1 (1) `max_smoke_nomiss' {
  4.                                 forvalues l = 0 (1) 1 {
  5.                                                                                 
.                                         * Mean risk of event at 30 days among age and sex group
.                                         qui summ risk30 if  smoke_nomiss==`k' & comorbidity_any==`l'
  6.                                         local r30 = r(mean)
  7.                                         
.                                         * Mean risk of event at 60 days among age and sex group
.                                         qui summ risk60 if smoke_nomiss==`k' & comorbidity_any==`l'
  8.                                         local r60 = r(mean)
  9.                                         
.                                         * Mean risk of event at 80 days among age and sex group
.                                         qui summ risk80 if  smoke_nomiss==`k' & comorbidity_any==`l'
 10.                                         local r80 = r(mean)
 11.                                         
.                                         post `temprf'  ("Smoking, comorb=`l'") (`k')  (`j') (`i') (`r
> 30') (`r60') (`r80')
 12.                                 }
 13.                         }
 14.                 }
 15.         }

.         
.         
.         * Other comorbidity groups?
.         
.         
. postclose `temprf'

. 
. 
. 
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/rp_parametric_survival_m
> odels_roy.log
  log type:  text
 closed on:  15 May 2020, 03:59:34
-------------------------------------------------------------------------------------------------------
