--------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_hiv_onscoviddeath.log
  log type:  text
 opened on:  30 Jun 2020, 15:22:46

. 
. use "cr_create_analysis_dataset_STSET_`outcome'.dta", clear
(Analysis dataset for the poor outcomes in Covid project)


. tab hiv

        HIV |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 17,016,650       98.49       98.49
          1 |    261,742        1.51      100.00
------------+-----------------------------------
      Total | 17,278,392      100.00

. tab hiv _d

           |  1 if failure; 0 if
           |       censored
       HIV |         0          1 |     Total
-----------+----------------------+----------
         0 |17,005,303     10,891 |17,016,194 
         1 |   261,706         35 |   261,741 
-----------+----------------------+----------
     Total |17,267,009     10,926 |17,277,935 


. tab agegrou if hiv==1

Grouped age |      Freq.     Percent        Cum.
------------+-----------------------------------
     18-<40 |    151,018       57.70       57.70
     40-<50 |     74,704       28.54       86.24
     50-<60 |     24,481        9.35       95.59
     60-<70 |      7,747        2.96       98.55
     70-<80 |      2,916        1.11       99.67
        80+ |        876        0.33      100.00
------------+-----------------------------------
      Total |    261,742      100.00


. tab male if hiv==1

       Male |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    210,224       80.32       80.32
          1 |     51,518       19.68      100.00
------------+-----------------------------------
      Total |    261,742      100.00


. 
. ******************************
. *  Age-sex Cox model  *
. ******************************
. capture stcox age1 age2 age3 i.male i.hiv, strata(stp) 

. if _rc==0 {
.                 estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,277,935                  Number of obs    =  17,277,935
No. of failures =       10,926
Time at risk    =   1638907207
                                                LR chi2(5)       =    33555.58
Log likelihood  =   -130301.29                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        age1 |   1.154554   .0242955     6.83   0.000     1.107904    1.203168
        age2 |   .9444223     .04332    -1.25   0.213     .8632213    1.033262
        age3 |   1.143166   .1214741     1.26   0.208      .928239    1.407859
      1.male |   1.777711   .0346489    29.52   0.000     1.711081    1.846935
       1.hiv |   1.600741   .2723009     2.77   0.006     1.146896    2.234181
------------------------------------------------------------------------------
                                                             Stratified by stp
.                 estimates save ./output/models/an_hiv_univariate, replace
(note: file ./output/models/an_hiv_univariate.ster not found)
file ./output/models/an_hiv_univariate.ster saved
.                 }

.         else di "WARNING - `var' vs `outcome' MODEL DID NOT SUCCESSFULLY FIT"

.         
. **************************************
. *  Demographics +/- ethnicity model  *
. **************************************
. capture stcox age1 age2 age3 i.male i.imd i.ethnicity i.hiv, strata(stp) 

. if _rc==0 {
.                 estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   12,717,951                  Number of obs    =  12,717,951
No. of failures =        8,149
Time at risk    =   1206440035
                                                LR chi2(13)      =    25652.46
Log likelihood  =   -94669.129                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------
                     _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------+----------------------------------------------------------------
                   age1 |   1.156013   .0283407     5.91   0.000      1.10178    1.212916
                   age2 |   .9453847    .050356    -1.05   0.292     .8516659    1.049416
                   age3 |   1.142514    .140744     1.08   0.279     .8974362    1.454519
                 1.male |   1.749224   .0394012    24.82   0.000     1.673679    1.828179
                        |
                    imd |
                     2  |   1.203672    .046144     4.84   0.000     1.116546    1.297597
                     3  |    1.36095   .0518591     8.09   0.000     1.263011    1.466484
                     4  |   1.726968   .0643539    14.66   0.000     1.605332    1.857819
       5 most deprived  |    2.10466    .079553    19.69   0.000     1.954375    2.266502
                        |
              ethnicity |
                 Mixed  |   1.462579   .1880279     2.96   0.003     1.136814    1.881694
Asian or Asian British  |   1.489432   .0678609     8.74   0.000     1.362193    1.628557
                 Black  |   1.580149   .1063945     6.79   0.000     1.384794    1.803064
                 Other  |   1.279209   .1248672     2.52   0.012      1.05646    1.548922
                        |
                  1.hiv |   1.521652   .2848743     2.24   0.025     1.054286    2.196201
-----------------------------------------------------------------------------------------
                                                             Stratified by stp
.                 estimates save ./output/models/an_hiv_adjdemographics_inceth, replace
(note: file ./output/models/an_hiv_adjdemographics_inceth.ster not found)
file ./output/models/an_hiv_adjdemographics_inceth.ster saved
.                 }

.         else di "WARNING - hiv adj demog inc CC eth MODEL DID NOT SUCCESSFULLY FIT"

. 
. capture stcox age1 age2 age3 i.male i.imd i.hiv, strata(stp) 

. if _rc==0 {
.                 estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,277,935                  Number of obs    =  17,277,935
No. of failures =       10,926
Time at risk    =   1638907207
                                                LR chi2(9)       =    34257.11
Log likelihood  =   -129950.52                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------
              _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
            age1 |   1.152095   .0241382     6.76   0.000     1.105743     1.20039
            age2 |   .9564406   .0437373    -0.97   0.330     .8744465    1.046123
            age3 |   1.103646    .116982     0.93   0.352     .8966149    1.358481
          1.male |   1.792918   .0349711    29.93   0.000     1.725669    1.862787
                 |
             imd |
              2  |   1.155097   .0370007     4.50   0.000     1.084807    1.229942
              3  |   1.312577   .0419092     8.52   0.000     1.232954    1.397343
              4  |   1.687724   .0529069    16.70   0.000      1.58715    1.794671
5 most deprived  |   2.112069   .0672864    23.47   0.000     1.984223    2.248152
                 |
           1.hiv |   1.567782   .2666644     2.64   0.008     1.123323    2.188098
----------------------------------------------------------------------------------
                                                             Stratified by stp
.                 estimates save ./output/models/an_hiv_adjdemographics_noeth, replace
(note: file ./output/models/an_hiv_adjdemographics_noeth.ster not found)
file ./output/models/an_hiv_adjdemographics_noeth.ster saved
.                 }

.         else di "WARNING - hiv adj demog no eth MODEL DID NOT SUCCESSFULLY FIT"

. 
. 
. ******************************
. *  Multivariable Cox model  *
. ******************************
. 
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. 
. 
.         
. timer clear
  5. timer on 1
  6.         capture stcox   i.hiv                   ///
>                         `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.reduced_kidney_function_cat   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_imm_except_hiv                  ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. basecoxmodel, age("age1 age2 age3") ethnicity(0) 
   1:   2690.30 /        1 =    2690.3010

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,277,935                  Number of obs    =  17,277,935
No. of failures =       10,926
Time at risk    =   1638907207
                                                LR chi2(37)      =    38752.23
Log likelihood  =   -127702.96                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                        1.hiv |   1.372579   .2334932     1.86   0.063     .9834154    1.915744
                         age1 |   1.173017   .0255992     7.31   0.000     1.123901    1.224279
                         age2 |   .8843674   .0419598    -2.59   0.010     .8058357    .9705522
                         age3 |   1.330859   .1461168     2.60   0.009     1.073192     1.65039
                       1.male |   1.590206   .0321433    22.95   0.000     1.528438     1.65447
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.049032   .0280344     1.79   0.073     .9955001    1.105443
          Obese II (35-39.9)  |   1.403516    .054817     8.68   0.000     1.300086    1.515175
             Obese III (40+)  |   1.914779   .1036116    12.00   0.000     1.722102    2.129014
                              |
                 smoke_nomiss |
                      Former  |   1.190304   .0257594     8.05   0.000     1.140872    1.241877
                     Current  |   .8917422   .0379969    -2.69   0.007     .8202945    .9694129
                              |
                          imd |
                           2  |   1.119654   .0358767     3.53   0.000       1.0515    1.192227
                           3  |    1.22489   .0391906     6.34   0.000     1.150437    1.304162
                           4  |   1.513337   .0477024    13.14   0.000     1.422671     1.60978
             5 most deprived  |   1.795322   .0579634    18.13   0.000     1.685235    1.912599
                              |
           1.htdiag_or_highbp |   .8906875   .0205657    -5.01   0.000     .8512779    .9319215
1.chronic_respiratory_disease |    1.62757   .0409075    19.38   0.000     1.549335    1.709754
                              |
                    asthmacat |
                 Yes, no OCS  |   .9909005    .030543    -0.30   0.767     .9328098    1.052609
                Yes with OCS  |   1.126602   .0637878     2.11   0.035     1.008267    1.258824
                              |
    1.chronic_cardiac_disease |   1.169582    .025261     7.25   0.000     1.121104    1.220155
                              |
                      diabcat |
         Controlled diabetes  |   1.306597   .0325353    10.74   0.000      1.24436    1.371947
       Uncontrolled diabetes  |   1.947723   .0624694    20.79   0.000     1.829054    2.074091
  Diabetes, no hba1c measure  |   1.899829   .0940513    12.96   0.000     1.724152    2.093405
                              |
            cancer_exhaem_cat |
                   Last year  |   1.717628   .1174544     7.91   0.000     1.502181    1.963974
               2-5 years ago  |   1.153951   .0559794     2.95   0.003     1.049288    1.269054
                    5+ years  |   .9635742   .0307116    -1.16   0.244     .9052221    1.025688
                              |
              cancer_haem_cat |
                   Last year  |   2.800998   .4288054     6.73   0.000     2.074924    3.781146
               2-5 years ago  |   2.463346   .2265308     9.80   0.000     2.057067    2.949867
                    5+ years  |   1.614093   .1240889     6.23   0.000      1.38832    1.876582
                              |
      1.chronic_liver_disease |   1.748735   .1331633     7.34   0.000     1.506283    2.030213
            1.stroke_dementia |   2.161273   .0523448    31.82   0.000     2.061077    2.266341
                1.other_neuro |   2.579202   .1047369    23.33   0.000     2.381878    2.792873
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.334536   .0304803    12.64   0.000     1.276113    1.395634
           Stage 4/5 egfr<30  |   2.518969   .0984451    23.64   0.000     2.333225      2.7195
                              |
           1.organ_transplant |   3.532592   .4354123    10.24   0.000     2.774457    4.497891
                     1.spleen |   1.338826   .2125184     1.84   0.066      .980864    1.827425
           1.ra_sle_psoriasis |   1.186158   .0402095     5.04   0.000      1.10991    1.267644
       1.other_imm_except_hiv |   2.192528   .3776111     4.56   0.000     1.564393    3.072872
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_hiv_multiv_noeth, replace
(note: file ./output/models/an_hiv_multiv_noeth.ster not found)
file ./output/models/an_hiv_multiv_noeth.ster saved
.  }

.  else di "WARNING HIV model (no eth) DID NOT FIT (OUTCOME `outcome')"

. 
. basecoxmodel, age("age1 age2 age3") ethnicity(1) 
   1:   2241.20 /        1 =    2241.2010

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   12,717,951                  Number of obs    =  12,717,951
No. of failures =        8,149
Time at risk    =   1206440035
                                                LR chi2(41)      =    28949.93
Log likelihood  =   -93020.398                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                        1.hiv |   1.341103    .251068     1.57   0.117     .9291992      1.9356
                         age1 |    1.17321    .029794     6.29   0.000     1.116245    1.233083
                         age2 |   .8823058   .0485492    -2.28   0.023     .7921025    .9827812
                         age3 |   1.341789   .1705634     2.31   0.021     1.045881    1.721416
                       1.male |   1.538768   .0360075    18.42   0.000     1.469788    1.610984
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.049611   .0320954     1.58   0.113     .9885529     1.11444
          Obese II (35-39.9)  |   1.414022   .0629888     7.78   0.000     1.295802    1.543028
             Obese III (40+)  |    1.92246    .119275    10.53   0.000      1.70234    2.171043
                              |
                 smoke_nomiss |
                      Former  |   1.223951   .0312836     7.91   0.000     1.164147    1.286827
                     Current  |   .9304314   .0455812    -1.47   0.141     .8452488    1.024199
                              |
                    ethnicity |
                       Mixed  |   1.436486   .1848976     2.81   0.005     1.116192     1.84869
      Asian or Asian British  |   1.443648   .0677311     7.83   0.000     1.316818    1.582694
                       Black  |   1.488134    .101135     5.85   0.000     1.302548    1.700163
                       Other  |   1.327134   .1298783     2.89   0.004     1.095501    1.607742
                              |
                          imd |
                           2  |     1.1613   .0445365     3.90   0.000      1.07721    1.251954
                           3  |    1.26405   .0482804     6.13   0.000     1.172878     1.36231
                           4  |   1.542505   .0577939    11.57   0.000      1.43329    1.660042
             5 most deprived  |   1.771185   .0678703    14.92   0.000     1.643034    1.909331
                              |
           1.htdiag_or_highbp |   .9093318   .0246666    -3.50   0.000     .8622488    .9589857
1.chronic_respiratory_disease |   1.652345   .0474391    17.49   0.000     1.561933    1.747989
                              |
                    asthmacat |
                 Yes, no OCS  |   .9360303   .0333632    -1.85   0.064     .8728714    1.003759
                Yes with OCS  |   1.080492   .0691762     1.21   0.227     .9530706    1.224949
                              |
    1.chronic_cardiac_disease |   1.160809   .0290273     5.96   0.000     1.105288    1.219119
                              |
                      diabcat |
         Controlled diabetes  |   1.280351   .0367792     8.60   0.000     1.210256    1.354504
       Uncontrolled diabetes  |    1.85433   .0686594    16.68   0.000     1.724527    1.993903
  Diabetes, no hba1c measure  |   1.862626   .1052514    11.01   0.000      1.66735    2.080772
                              |
            cancer_exhaem_cat |
                   Last year  |   1.673005   .1345548     6.40   0.000     1.429018     1.95865
               2-5 years ago  |   1.211455   .0670372     3.47   0.001     1.086939    1.350236
                    5+ years  |   .9848601    .036374    -0.41   0.680     .9160876    1.058796
                              |
              cancer_haem_cat |
                   Last year  |   2.336937   .4512445     4.40   0.000     1.600614    3.411988
               2-5 years ago  |   2.525301    .266737     8.77   0.000     2.053073    3.106147
                    5+ years  |   1.557861   .1408665     4.90   0.000     1.304849    1.859931
                              |
      1.chronic_liver_disease |   1.752751   .1501865     6.55   0.000     1.481781    2.073273
            1.stroke_dementia |   2.163526   .0605463    27.58   0.000     2.048053    2.285509
                1.other_neuro |    2.52974    .119129    19.71   0.000     2.306703    2.774343
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |     1.3663   .0363037    11.75   0.000     1.296968     1.43934
           Stage 4/5 egfr<30  |    2.50326   .1136396    20.21   0.000     2.290152    2.736199
                              |
           1.organ_transplant |   3.459858    .486624     8.83   0.000     2.626262    4.558044
                     1.spleen |    1.34382   .2423362     1.64   0.101     .9437142    1.913557
           1.ra_sle_psoriasis |   1.150888   .0455391     3.55   0.000     1.065006    1.243695
       1.other_imm_except_hiv |   2.170499   .4273768     3.94   0.000     1.475556    3.192738
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_hiv_multiv_CCeth, replace
(note: file ./output/models/an_hiv_multiv_CCeth.ster not found)
file ./output/models/an_hiv_multiv_CCeth.ster saved
.  }

.  else di "WARNING HIV model (CC eth) DID NOT FIT (OUTCOME `outcome')"

. 
.  
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_hiv_onscoviddeath.log
  log type:  text
 closed on:  30 Jun 2020, 17:25:04
--------------------------------------------------------------------------------------------------------------------
