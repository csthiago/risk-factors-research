--------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_multivariable_cox_models_cpnsdeath
> .log
  log type:  text
 opened on:   3 Jun 2020, 03:19:00

. 
. use "cr_create_analysis_dataset_STSET_`outcome'.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.reduced_kidney_function_cat   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  bp("i.htdiag_or_highbp") ethnicity(0)
   1:   2917.03 /        1 =    2917.0350

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,277,935                  Number of obs    =  17,277,935
No. of failures =        5,647
Time at risk    =   1449460311
                                                LR chi2(36)      =    18758.81
Log likelihood  =   -66561.723                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.131738   .0273579     5.12   0.000     1.079368    1.186649
                         age2 |   .9633908    .051925    -0.69   0.489     .8668108    1.070732
                         age3 |   1.046166   .1321607     0.36   0.721     .8167135    1.340084
                       1.male |   1.983006    .057085    23.78   0.000     1.874219    2.098107
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.268686   .0439501     6.87   0.000     1.185405    1.357818
          Obese II (35-39.9)  |   1.555286   .0791661     8.68   0.000     1.407612    1.718453
             Obese III (40+)  |    2.25396    .151133    12.12   0.000     1.976384    2.570521
                              |
                 smoke_nomiss |
                      Former  |   1.245714   .0383199     7.14   0.000     1.172827    1.323129
                     Current  |   .8766516   .0507612    -2.27   0.023     .7825993     .982007
                              |
                          imd |
                           2  |   1.134359   .0512058     2.79   0.005     1.038309    1.239294
                           3  |   1.228613   .0552104     4.58   0.000     1.125031    1.341732
                           4  |   1.491777   .0659714     9.04   0.000     1.367921    1.626848
             5 most deprived  |   1.732172   .0785478    12.12   0.000     1.584864    1.893171
                              |
           1.htdiag_or_highbp |    .933342   .0302701    -2.13   0.033       .87586    .9945965
1.chronic_respiratory_disease |   1.785964   .0607384    17.05   0.000       1.6708    1.909067
                              |
                    asthmacat |
                 Yes, no OCS  |   1.105713   .0450388     2.47   0.014      1.02087    1.197607
                Yes with OCS  |   1.248567   .0917543     3.02   0.003     1.081083    1.441999
                              |
    1.chronic_cardiac_disease |   1.245012   .0374169     7.29   0.000     1.173794     1.32055
                              |
                      diabcat |
         Controlled diabetes  |   1.479056   .0503113    11.51   0.000     1.383663    1.581026
       Uncontrolled diabetes  |   2.266102   .0945387    19.61   0.000     2.088183    2.459181
  Diabetes, no hba1c measure  |    1.82471   .1312872     8.36   0.000     1.584712    2.101056
                              |
            cancer_exhaem_cat |
                   Last year  |   1.556317   .1531775     4.49   0.000     1.283277    1.887452
               2-5 years ago  |   1.179886   .0776161     2.51   0.012      1.03716    1.342253
                    5+ years  |   .9566124   .0434478    -0.98   0.329     .8751365    1.045674
                              |
              cancer_haem_cat |
                   Last year  |   3.333839   .6442525     6.23   0.000     2.282722    4.868961
               2-5 years ago  |   3.061764    .347689     9.85   0.000     2.450815    3.825012
                    5+ years  |   1.859131   .1864733     6.18   0.000     1.527332    2.263011
                              |
      1.chronic_liver_disease |   1.652728   .1680798     4.94   0.000     1.354052    2.017285
            1.stroke_dementia |   1.748807   .0634914    15.40   0.000      1.62869    1.877782
                1.other_neuro |   2.466833   .1461877    15.24   0.000     2.196324    2.770658
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.553814   .0503972    13.59   0.000     1.458112    1.655798
           Stage 4/5 egfr<30  |   3.490313   .1806925    24.15   0.000     3.153537    3.863055
                              |
           1.organ_transplant |   3.626891   .5344502     8.74   0.000     2.717086     4.84134
                     1.spleen |   1.407122   .2947166     1.63   0.103     .9333636    2.121353
           1.ra_sle_psoriasis |   1.230879   .0566422     4.51   0.000     1.124721    1.347056
    1.other_immunosuppression |   1.777741   .2736305     3.74   0.000     1.314775     2.40373
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth, repl
> ace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_noeth.ster not f
> ound)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"

.  
. *Age group model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup") bp("i.htdiag_or_highbp") ethnicity(0)
   1:   2770.53 /        1 =    2770.5340

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,277,935                  Number of obs    =  17,277,935
No. of failures =        5,647
Time at risk    =   1449460311
                                                LR chi2(38)      =    18273.47
Log likelihood  =   -66804.395                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |   .0696122   .0116574   -15.91   0.000     .0501351     .096656
                      40-<50  |   .3074509   .0357545   -10.14   0.000      .244786    .3861579
                      60-<70  |   2.118607   .1396053    11.39   0.000     1.861919    2.410684
                      70-<80  |   4.885775   .2997436    25.86   0.000     4.332235    5.510042
                         80+  |   12.75658   .7943573    40.89   0.000     11.29093    14.41249
                              |
                       1.male |   1.889276   .0540875    22.22   0.000     1.786186    1.998316
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.194785   .0411437     5.17   0.000     1.116806    1.278209
          Obese II (35-39.9)  |   1.434617    .072641     7.13   0.000      1.29908    1.584295
             Obese III (40+)  |    2.04469   .1364683    10.72   0.000     1.793973    2.330446
                              |
                 smoke_nomiss |
                      Former  |   1.251088   .0385364     7.27   0.000     1.177793    1.328945
                     Current  |   .8329249    .048082    -3.17   0.002     .7438216     .932702
                              |
                          imd |
                           2  |   1.135713   .0512675     2.82   0.005     1.039547    1.240774
                           3  |   1.231266   .0553422     4.63   0.000     1.127438    1.344656
                           4  |   1.492552    .066048     9.05   0.000     1.368555    1.627783
             5 most deprived  |   1.726189   .0783257    12.03   0.000     1.579302    1.886738
                              |
           1.htdiag_or_highbp |   .9614243   .0312818    -1.21   0.227     .9020273    1.024733
1.chronic_respiratory_disease |   1.775142   .0604988    16.84   0.000     1.660441    1.897768
                              |
                    asthmacat |
                 Yes, no OCS  |    1.08642   .0442383     2.04   0.042     1.003084    1.176679
                Yes with OCS  |   1.222506   .0898102     2.73   0.006     1.058567    1.411834
                              |
    1.chronic_cardiac_disease |   1.280503   .0385978     8.20   0.000     1.207044    1.358432
                              |
                      diabcat |
         Controlled diabetes  |   1.451529   .0494894    10.93   0.000     1.357701     1.55184
       Uncontrolled diabetes  |   2.165843   .0904221    18.51   0.000     1.995676     2.35052
  Diabetes, no hba1c measure  |   1.865689   .1343006     8.66   0.000      1.62019    2.148387
                              |
            cancer_exhaem_cat |
                   Last year  |   1.546726    .152235     4.43   0.000     1.275366    1.875824
               2-5 years ago  |   1.168867   .0769189     2.37   0.018     1.027426    1.329779
                    5+ years  |   .9705591   .0441133    -0.66   0.511     .8878379    1.060988
                              |
              cancer_haem_cat |
                   Last year  |   3.253884   .6287626     6.11   0.000     2.228028    4.752078
               2-5 years ago  |   2.957502   .3358862     9.55   0.000       2.3673     3.69485
                    5+ years  |    1.83501   .1840759     6.05   0.000      1.50748    2.233702
                              |
      1.chronic_liver_disease |   1.612455    .163698     4.71   0.000     1.321517    1.967444
            1.stroke_dementia |   1.825037   .0662489    16.57   0.000     1.699703    1.959613
                1.other_neuro |   2.410628   .1429624    14.84   0.000     2.146099    2.707764
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.708314   .0546984    16.72   0.000     1.604401    1.818956
           Stage 4/5 egfr<30  |   4.052836    .207572    27.32   0.000     3.665755     4.48079
                              |
           1.organ_transplant |   3.256867   .4794026     8.02   0.000     2.440649    4.346051
                     1.spleen |   1.376138   .2882004     1.52   0.127      .912846    2.074563
           1.ra_sle_psoriasis |   1.211931   .0557623     4.18   0.000     1.107422    1.326303
    1.other_immunosuppression |    1.69827   .2612561     3.44   0.001     1.256206    2.295898
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agegroup_bmicat_noeth, repla
> ce
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster not fo
> und)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING GROUP MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3") bp("i.htdiag_or_highbp") ethnicity(1)
   1:   2213.01 /        1 =    2213.0120

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   12,717,951                  Number of obs    =  12,717,951
No. of failures =        4,199
Time at risk    =   1066977045
                                                LR chi2(40)      =    13914.54
Log likelihood  =   -48384.606                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.115329   .0302365     4.03   0.000     1.057613    1.176194
                         age2 |   .9964292   .0604212    -0.06   0.953     .8847724    1.122177
                         age3 |   .9650518   .1373508    -0.25   0.803     .7301355    1.275551
                       1.male |    1.92385   .0641595    19.62   0.000     1.802121    2.053801
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.281543   .0509286     6.24   0.000     1.185513    1.385351
          Obese II (35-39.9)  |   1.595119   .0925472     8.05   0.000     1.423663    1.787224
             Obese III (40+)  |   2.268403   .1755617    10.58   0.000     1.949135    2.639967
                              |
                 smoke_nomiss |
                      Former  |   1.311605   .0478513     7.44   0.000     1.221093    1.408826
                     Current  |   .9317668    .062197    -1.06   0.290     .8175007    1.062004
                              |
                    ethnicity |
                       Mixed  |   1.623181   .2640085     2.98   0.003     1.180103    2.232615
      Asian or Asian British  |   1.594621   .0977308     7.61   0.000      1.41413     1.79815
                       Black  |   1.670839   .1447724     5.92   0.000     1.409876    1.980105
                       Other  |   1.324433   .1770931     2.10   0.036     1.019093    1.721259
                              |
                          imd |
                           2  |   1.190018   .0645164     3.21   0.001     1.070055    1.323431
                           3  |   1.253995   .0677234     4.19   0.000     1.128044     1.39401
                           4  |    1.53256   .0808221     8.10   0.000     1.382063    1.699445
             5 most deprived  |   1.684045   .0912866     9.62   0.000     1.514303    1.872813
                              |
           1.htdiag_or_highbp |    .961992   .0367009    -1.02   0.310     .8926831    1.036682
1.chronic_respiratory_disease |   1.795414   .0702733    14.95   0.000     1.662831    1.938568
                              |
                    asthmacat |
                 Yes, no OCS  |   1.029051   .0488648     0.60   0.546     .9375993    1.129422
                Yes with OCS  |   1.245485   .1020216     2.68   0.007     1.060752     1.46239
                              |
    1.chronic_cardiac_disease |   1.245884   .0434993     6.30   0.000     1.163479    1.334126
                              |
                      diabcat |
         Controlled diabetes  |   1.455471   .0574151     9.51   0.000      1.34718    1.572467
       Uncontrolled diabetes  |   2.147731   .1041657    15.76   0.000     1.952973     2.36191
  Diabetes, no hba1c measure  |   1.861983   .1505581     7.69   0.000     1.589089     2.18174
                              |
            cancer_exhaem_cat |
                   Last year  |    1.68149   .1861509     4.69   0.000     1.353509    2.088946
               2-5 years ago  |   1.200423   .0919152     2.39   0.017     1.033139    1.394794
                    5+ years  |   1.007952   .0527394     0.15   0.880     .9097084    1.116806
                              |
              cancer_haem_cat |
                   Last year  |   3.090185   .7118714     4.90   0.000     1.967421    4.853687
               2-5 years ago  |   3.370905   .4257057     9.62   0.000     2.631781    4.317609
                    5+ years  |   1.811363   .2132897     5.05   0.000     1.438056    2.281578
                              |
      1.chronic_liver_disease |   1.647456   .1883203     4.37   0.000      1.31678    2.061173
            1.stroke_dementia |   1.706077   .0723091    12.60   0.000      1.57008    1.853853
                1.other_neuro |   2.413627   .1671665    12.72   0.000     2.107251    2.764546
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.597222   .0603302    12.40   0.000     1.483248    1.719954
           Stage 4/5 egfr<30  |   3.434699   .2076484    20.41   0.000     3.050903    3.866776
                              |
           1.organ_transplant |   3.929325   .6279495     8.56   0.000     2.872675     5.37464
                     1.spleen |   1.425578   .3375749     1.50   0.134      .896247    2.267537
           1.ra_sle_psoriasis |   1.169136     .06354     2.88   0.004     1.051004    1.300547
    1.other_immunosuppression |   1.777981    .299819     3.41   0.001     1.277585    2.474368
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCeth, repl
> ace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster not f
> ound)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL WITH AGESPLINE DID NOT FIT (OUTCOME `outcome')"

.  
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/an_multivariable_cox_models_cpnsdeath
> .log
  log type:  text
 closed on:   3 Jun 2020, 05:31:10
--------------------------------------------------------------------------------------------------------------------
