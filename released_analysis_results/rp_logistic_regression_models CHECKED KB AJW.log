-------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/rp_logistic_regression_m
> odels.log
  log type:  text
 opened on:  15 May 2020, 20:55:03

. cap erase ./output/models/rp_logistic_regression_models.ster

. 
. 
. 
. 
. *************************
. *  Parameters required  *
. *************************
. 
. 
. set seed 37873

. noi di "Sampling fraction for controls = " $sampling_frac
Sampling fraction for controls = .003

.  
. 
. 
. ***************
. *  Open data  *
. ***************
. 
. use "cr_create_analysis_dataset_STSET_cpnsdeath.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. tab cpnsdeath 

Failure/cen |
     soring |
  indicator |
        for |
   outcome: |
 CPNS covid |
      death |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 17,277,628       99.97       99.97
          1 |      5,651        0.03      100.00
------------+-----------------------------------
      Total | 17,283,279      100.00

. 
. 
. 
. *************************************************
. *   Use a complete case analysis for ethnicity  *
. *************************************************
. 
. drop if ethnicity>=.
(4,563,711 observations deleted)

. 
. 
. ********************
. *   Select sample  *
. ********************
. 
. * Identify all deaths occurring over the next month, starting each two-week
. * period (i.e. overlapping 28-day periods) 
. * In each two-week period: Select a sample comprising all cases and a random
. * selection of controls (people at risk at start of period)
. forvalues t = 2 (1) 5 {
  2.                 local lb = (`t' - 1)*14 
  3.                 local ub = `lb' + 28
  4.                 gen case`t' = (cpnsdeath==1 & inrange(_t, `lb', `ub'))
  5.                 gen atrisk`t' = _t>`lb'
  6.                 gen control`t' = (uniform()<$sampling_frac) if atrisk`t'==1
  7. }
(4,723 missing values generated)
(9,411 missing values generated)
(14,286 missing values generated)
(19,927 missing values generated)

. 
. * Delete people who are neither case nor control
. egen case = rowtotal(case?)

. tab case

       case |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 12,715,365       99.97       99.97
          1 |      1,706        0.01       99.98
          2 |      2,406        0.02      100.00
          3 |         91        0.00      100.00
------------+-----------------------------------
      Total | 12,719,568      100.00

. egen control = rowtotal(control?)

. tab control

    control |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 12,567,501       98.80       98.80
          1 |    151,383        1.19       99.99
          2 |        682        0.01      100.00
          3 |          2        0.00      100.00
------------+-----------------------------------
      Total | 12,719,568      100.00

. drop if case==0 & control==0  
(12,563,339 observations deleted)

. 
. * Combine separate case-control samples
. forvalues t = 2 (1) 5 {
  2.         preserve 
  3.         keep if case`t'==1 | control`t'==1
  4.         gen outcome = 1 if case`t'==1
  5.         replace outcome = 0 if outcome==.
  6.         gen time = `t'
  7.         gen days_fup = min(28, (_t - (`t'-1)*14))
  8.         replace days_fup = 0.5 if days_fup==0
  9.         drop case* control* atrisk* _* stime*
 10.         save time`t'.dta, replace
 11.         restore
 12. }
(118,071 observations deleted)
(38,152 missing values generated)
(38,152 real changes made)
(0 real changes made)
(note: file time2.dta not found)
file time2.dta saved
(117,514 observations deleted)
(38,273 missing values generated)
(38,273 real changes made)
(0 real changes made)
(note: file time3.dta not found)
file time3.dta saved
(115,366 observations deleted)
(38,369 missing values generated)
(38,369 real changes made)
(3 real changes made)
(note: file time4.dta not found)
file time4.dta saved
(114,439 observations deleted)
(37,941 missing values generated)
(37,941 real changes made)
(88 real changes made)
(note: file time5.dta not found)
file time5.dta saved

. use time2.dta, clear
(Analysis dataset for the poor outcomes in Covid project)

. forvalues t = 3 (1) 5 {
  2.         append using time`t'.dta        
  3. }
(label diabcat already defined)
(label hba1ccat already defined)
(label reduced_kidney_function_catlab already defined)
(label ckd already defined)
(label cancer already defined)
(label imd already defined)
(label bpcat already defined)
(label asthmacat already defined)
(label obese4cat already defined)
(label bmicat already defined)
(label agegroup already defined)
(label ethnicity already defined)
(label smoke already defined)
(label smoke already defined)
(label ethnicity already defined)
(label agegroup already defined)
(label bmicat already defined)
(label obese4cat already defined)
(label asthmacat already defined)
(label bpcat already defined)
(label imd already defined)
(label cancer already defined)
(label ckd already defined)
(label reduced_kidney_function_catlab already defined)
(label hba1ccat already defined)
(label diabcat already defined)
(label diabcat already defined)
(label hba1ccat already defined)
(label reduced_kidney_function_catlab already defined)
(label ckd already defined)
(label cancer already defined)
(label imd already defined)
(label bpcat already defined)
(label asthmacat already defined)
(label obese4cat already defined)
(label bmicat already defined)
(label agegroup already defined)
(label ethnicity already defined)
(label smoke already defined)

. forvalues t = 2 (1) 5 {
  2.         erase time`t'.dta
  3. }

. tab outcome time 

           |                    time
   outcome |         2          3          4          5 |     Total
-----------+--------------------------------------------+----------
         0 |    38,152     38,273     38,369     37,941 |   152,735 
         1 |         6        442      2,494      3,849 |     6,791 
-----------+--------------------------------------------+----------
     Total |    38,158     38,715     40,863     41,790 |   159,526 

.  
. 
. 
. 
. *******************************
. *  Create variables required  *
. *******************************
. 
. 
. /*   Comorbidity counts for assessing risk  */
. 
. * Create absent/present for categorical comorbidities
. recode asthma 1=0 2/3=1, gen(asthmabin)
(26120 differences between asthma and asthmabin)

. recode diabcat 1=0 2/4=1, gen(diabbin)
(159526 differences between diabcat and diabbin)

. recode cancer_exhaem_cat 1=0 2/4=1, gen(cancer_exhaem_bin)
(159526 differences between cancer_exhaem_cat and cancer_exhaem_bin)

. recode cancer_haem_cat 1=0 2/4=1, gen(cancer_haem_bin)
(159526 differences between cancer_haem_cat and cancer_haem_bin)

. recode reduced_kidney_function_cat 1=0 2/3=1, gen(kidneybin)
(159526 differences between reduced_kidney_function_cat and kidneybin)

. 
. * Count comorbidities present
. egen comorbidity_count = rowtotal(                      ///
>                         htdiag_or_highbp                                ///
>                         chronic_respiratory_disease     ///
>                         asthmabin                                               ///
>                         chronic_cardiac_disease                 ///
>                         diabbin                                                 ///
>                         cancer_exhaem_bin                               ///
>                         cancer_haem_bin                                 ///
>                         chronic_liver_disease                   ///
>                         stroke_dementia                                 ///
>                         kidneybin                                               ///
>                         other_neuro                                             ///
>                         organ_transplant                                ///
>                         spleen                                                  ///
>                         ra_sle_psoriasis                                ///
>                         other_immunosuppression                 ///
>                         )

. drop asthmabin diabbin cancer_exhaem_bin cancer_haem_bin kidneybin

. 
. recode comorbidity_count 1/max=1 0=0, gen(comorbidity_any)
(35190 differences between comorbidity_count and comorbidity_any)

. 
. 
. * Create numerical region variable
. encode region, gen(region_new)

. drop region

. rename region_new region

. 
. 
. 
. 
. 
. 
. **************************
. *   Logistic regression  *
. **************************
. 
. 
. * At present: no ethnicity
. timer clear 1

. timer on 1

. logit outcome age1 age2 age3 i.male             ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.reduced_kidney_function_cat   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression               ///
>                         i.region                                                ///
>                         i.time, cluster(patient_id)

Iteration 0:   log pseudolikelihood =  -28080.54  
Iteration 1:   log pseudolikelihood = -19982.463  
Iteration 2:   log pseudolikelihood =  -16478.99  
Iteration 3:   log pseudolikelihood =   -15238.1  
Iteration 4:   log pseudolikelihood = -14958.699  
Iteration 5:   log pseudolikelihood = -14917.231  
Iteration 6:   log pseudolikelihood = -14913.278  
Iteration 7:   log pseudolikelihood = -14913.145  
Iteration 8:   log pseudolikelihood = -14913.145  

Logistic regression                             Number of obs     =    159,518
                                                Wald chi2(47)     =    8638.32
                                                Prob > chi2       =     0.0000
Log pseudolikelihood = -14913.145               Pseudo R2         =     0.4689

                                        (Std. Err. adjusted for 156,221 clusters in patient_id)
-----------------------------------------------------------------------------------------------
                              |               Robust
                      outcome |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   .1112653    .029369     3.79   0.000     .0537031    .1688274
                         age2 |  -.0432147   .0656523    -0.66   0.510    -.1718909    .0854615
                         age3 |   .0930798   .1544677     0.60   0.547    -.2096713     .395831
                       1.male |   .7299837   .0418533    17.44   0.000     .6479527    .8120147
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .2719791   .0509183     5.34   0.000      .172181    .3717771
          Obese II (35-39.9)  |   .4058942   .0773009     5.25   0.000     .2543872    .5574012
             Obese III (40+)  |   .9139036   .1023938     8.93   0.000     .7132155    1.114592
                              |
                 smoke_nomiss |
                      Former  |   .1637104   .0445251     3.68   0.000     .0764428    .2509781
                     Current  |  -.2206716   .0782915    -2.82   0.005    -.3741202   -.0672229
                              |
                          imd |
                           2  |   .1373969   .0657436     2.09   0.037     .0085418     .266252
                           3  |   .2006156    .065909     3.04   0.002     .0714363    .3297949
                           4  |   .3599026      .0649     5.55   0.000      .232701    .4871041
             5 most deprived  |   .4876382   .0664699     7.34   0.000     .3573597    .6179168
                              |
           1.htdiag_or_highbp |   .0068254    .046969     0.15   0.884     -.085232    .0988829
1.chronic_respiratory_disease |   .7900217   .0556514    14.20   0.000     .6809469    .8990966
                              |
                    asthmacat |
                 Yes, no OCS  |   .0542724   .0614261     0.88   0.377    -.0661206    .1746653
                Yes with OCS  |   .3279648   .1136865     2.88   0.004     .1051433    .5507864
                              |
    1.chronic_cardiac_disease |   .2863768   .0469968     6.09   0.000     .1942647     .378489
                              |
                      diabcat |
         Controlled diabetes  |   .5085391    .052366     9.71   0.000     .4059037    .6111746
       Uncontrolled diabetes  |   1.013295   .0673237    15.05   0.000     .8813428    1.145247
  Diabetes, no hba1c measure  |   .7818544   .1148937     6.81   0.000     .5566669    1.007042
                              |
            cancer_exhaem_cat |
                   Last year  |   .7149871   .1655408     4.32   0.000     .3905331    1.039441
               2-5 years ago  |   .2729648   .1026365     2.66   0.008     .0718009    .4741286
                    5+ years  |   .0282089   .0703952     0.40   0.689    -.1097631    .1661808
                              |
              cancer_haem_cat |
                   Last year  |   1.639966   .4035542     4.06   0.000     .8490145    2.430918
               2-5 years ago  |   1.722923   .2159671     7.98   0.000     1.299635    2.146211
                    5+ years  |   .6356538   .1554747     4.09   0.000     .3309291    .9403786
                              |
      1.chronic_liver_disease |   .6894055   .1507068     4.57   0.000     .3940256    .9847854
            1.stroke_dementia |   .5524906   .0627669     8.80   0.000     .4294697    .6755114
                1.other_neuro |   1.077238   .1131294     9.52   0.000     .8555082    1.298967
                              |
  reduced_kidney_function_cat |
    Stage 3a/3b egfr 30-60    |   .4658678   .0494561     9.42   0.000     .3689356       .5628
           Stage 4/5 egfr<30  |   1.585164   .1088551    14.56   0.000     1.371812    1.798517
                              |
           1.organ_transplant |   1.294053   .2324373     5.57   0.000     .8384838    1.749621
                     1.spleen |   .4783627    .348942     1.37   0.170     -.205551    1.162276
           1.ra_sle_psoriasis |   .3010714   .0724653     4.15   0.000     .1590421    .4431008
    1.other_immunosuppression |   .7973999    .217632     3.66   0.000      .370849    1.223951
                              |
                       region |
               East Midlands  |  -.1617978   .0624781    -2.59   0.010    -.2842526    -.039343
                      London  |   .7155231    .077201     9.27   0.000     .5642118    .8668344
                  North East  |  -.3303979   .0992835    -3.33   0.001      -.52499   -.1358058
                  North West  |  -.1290598   .0719597    -1.79   0.073    -.2700983    .0119787
                  South East  |  -.2687907   .1001301    -2.68   0.007    -.4650421   -.0725393
                  South West  |  -.8231124   .0832194    -9.89   0.000    -.9862194   -.6600054
               West Midlands  |   .6546453   .0844187     7.75   0.000     .4891876     .820103
    Yorkshire and The Humber  |  -.2123466   .0675469    -3.14   0.002     -.344736   -.0799571
                              |
                         time |
                           3  |   4.341097   .4080858    10.64   0.000     3.541263     5.14093
                           4  |   6.112235   .4105603    14.89   0.000     5.307551    6.916918
                           5  |   6.584752   .4108125    16.03   0.000     5.779574    7.389929
                              |
                        _cons |  -16.95669   1.135818   -14.93   0.000    -19.18285   -14.73053
-----------------------------------------------------------------------------------------------

. timer off 1

. timer list 1
   1:     10.41 /        1 =      10.4110

. estat ic

Akaike's information criterion and Bayesian information criterion

-----------------------------------------------------------------------------
       Model |          N   ll(null)  ll(model)      df        AIC        BIC
-------------+---------------------------------------------------------------
           . |    159,518  -28080.54  -14913.15      48   29922.29   30401.33
-----------------------------------------------------------------------------
Note: BIC uses N = number of observations. See [R] BIC note.

. 
. estimates

-------------------------------------------------------------------------------------------------------
active results
-------------------------------------------------------------------------------------------------------

Logistic regression                             Number of obs     =    159,518
                                                Wald chi2(47)     =    8638.32
                                                Prob > chi2       =     0.0000
Log pseudolikelihood = -14913.145               Pseudo R2         =     0.4689

                                        (Std. Err. adjusted for 156,221 clusters in patient_id)
-----------------------------------------------------------------------------------------------
                              |               Robust
                      outcome |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   .1112653    .029369     3.79   0.000     .0537031    .1688274
                         age2 |  -.0432147   .0656523    -0.66   0.510    -.1718909    .0854615
                         age3 |   .0930798   .1544677     0.60   0.547    -.2096713     .395831
                       1.male |   .7299837   .0418533    17.44   0.000     .6479527    .8120147
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .2719791   .0509183     5.34   0.000      .172181    .3717771
          Obese II (35-39.9)  |   .4058942   .0773009     5.25   0.000     .2543872    .5574012
             Obese III (40+)  |   .9139036   .1023938     8.93   0.000     .7132155    1.114592
                              |
                 smoke_nomiss |
                      Former  |   .1637104   .0445251     3.68   0.000     .0764428    .2509781
                     Current  |  -.2206716   .0782915    -2.82   0.005    -.3741202   -.0672229
                              |
                          imd |
                           2  |   .1373969   .0657436     2.09   0.037     .0085418     .266252
                           3  |   .2006156    .065909     3.04   0.002     .0714363    .3297949
                           4  |   .3599026      .0649     5.55   0.000      .232701    .4871041
             5 most deprived  |   .4876382   .0664699     7.34   0.000     .3573597    .6179168
                              |
           1.htdiag_or_highbp |   .0068254    .046969     0.15   0.884     -.085232    .0988829
1.chronic_respiratory_disease |   .7900217   .0556514    14.20   0.000     .6809469    .8990966
                              |
                    asthmacat |
                 Yes, no OCS  |   .0542724   .0614261     0.88   0.377    -.0661206    .1746653
                Yes with OCS  |   .3279648   .1136865     2.88   0.004     .1051433    .5507864
                              |
    1.chronic_cardiac_disease |   .2863768   .0469968     6.09   0.000     .1942647     .378489
                              |
                      diabcat |
         Controlled diabetes  |   .5085391    .052366     9.71   0.000     .4059037    .6111746
       Uncontrolled diabetes  |   1.013295   .0673237    15.05   0.000     .8813428    1.145247
  Diabetes, no hba1c measure  |   .7818544   .1148937     6.81   0.000     .5566669    1.007042
                              |
            cancer_exhaem_cat |
                   Last year  |   .7149871   .1655408     4.32   0.000     .3905331    1.039441
               2-5 years ago  |   .2729648   .1026365     2.66   0.008     .0718009    .4741286
                    5+ years  |   .0282089   .0703952     0.40   0.689    -.1097631    .1661808
                              |
              cancer_haem_cat |
                   Last year  |   1.639966   .4035542     4.06   0.000     .8490145    2.430918
               2-5 years ago  |   1.722923   .2159671     7.98   0.000     1.299635    2.146211
                    5+ years  |   .6356538   .1554747     4.09   0.000     .3309291    .9403786
                              |
      1.chronic_liver_disease |   .6894055   .1507068     4.57   0.000     .3940256    .9847854
            1.stroke_dementia |   .5524906   .0627669     8.80   0.000     .4294697    .6755114
                1.other_neuro |   1.077238   .1131294     9.52   0.000     .8555082    1.298967
                              |
  reduced_kidney_function_cat |
    Stage 3a/3b egfr 30-60    |   .4658678   .0494561     9.42   0.000     .3689356       .5628
           Stage 4/5 egfr<30  |   1.585164   .1088551    14.56   0.000     1.371812    1.798517
                              |
           1.organ_transplant |   1.294053   .2324373     5.57   0.000     .8384838    1.749621
                     1.spleen |   .4783627    .348942     1.37   0.170     -.205551    1.162276
           1.ra_sle_psoriasis |   .3010714   .0724653     4.15   0.000     .1590421    .4431008
    1.other_immunosuppression |   .7973999    .217632     3.66   0.000      .370849    1.223951
                              |
                       region |
               East Midlands  |  -.1617978   .0624781    -2.59   0.010    -.2842526    -.039343
                      London  |   .7155231    .077201     9.27   0.000     .5642118    .8668344
                  North East  |  -.3303979   .0992835    -3.33   0.001      -.52499   -.1358058
                  North West  |  -.1290598   .0719597    -1.79   0.073    -.2700983    .0119787
                  South East  |  -.2687907   .1001301    -2.68   0.007    -.4650421   -.0725393
                  South West  |  -.8231124   .0832194    -9.89   0.000    -.9862194   -.6600054
               West Midlands  |   .6546453   .0844187     7.75   0.000     .4891876     .820103
    Yorkshire and The Humber  |  -.2123466   .0675469    -3.14   0.002     -.344736   -.0799571
                              |
                         time |
                           3  |   4.341097   .4080858    10.64   0.000     3.541263     5.14093
                           4  |   6.112235   .4105603    14.89   0.000     5.307551    6.916918
                           5  |   6.584752   .4108125    16.03   0.000     5.779574    7.389929
                              |
                        _cons |  -16.95669   1.135818   -14.93   0.000    -19.18285   -14.73053
-----------------------------------------------------------------------------------------------

. estimates save ./output/models/rp_logistic_regression_models.ster, replace
(note: file ./output/models/rp_logistic_regression_models.ster not found)
file ./output/models/rp_logistic_regression_models.ster saved

. logit, or

Logistic regression                             Number of obs     =    159,518
                                                Wald chi2(47)     =    8638.32
                                                Prob > chi2       =     0.0000
Log pseudolikelihood = -14913.145               Pseudo R2         =     0.4689

                                        (Std. Err. adjusted for 156,221 clusters in patient_id)
-----------------------------------------------------------------------------------------------
                              |               Robust
                      outcome | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.117691   .0328255     3.79   0.000     1.055171    1.183916
                         age2 |   .9577057   .0628756    -0.66   0.510      .842071     1.08922
                         age3 |   1.097549   .1695359     0.60   0.547     .8108507    1.485618
                       1.male |   2.075047   .0868476    17.44   0.000     1.911623    2.252442
                              |
                    obese4cat |
           Obese I (30-34.9)  |    1.31256   .0668333     5.34   0.000     1.187893     1.45031
          Obese II (35-39.9)  |   1.500644   .1160011     5.25   0.000     1.289671    1.746129
             Obese III (40+)  |   2.494039   .2553741     8.93   0.000     2.040542    3.048323
                              |
                 smoke_nomiss |
                      Former  |   1.177873    .052445     3.68   0.000      1.07944    1.285282
                     Current  |     .80198   .0627883    -2.82   0.005     .6878942    .9349867
                              |
                          imd |
                           2  |   1.147283   .0754266     2.09   0.037     1.008578    1.305064
                           3  |   1.222155    .080551     3.04   0.002      1.07405    1.390683
                           4  |    1.43319    .093014     5.55   0.000     1.262004    1.627596
             5 most deprived  |   1.628466   .1082439     7.34   0.000      1.42955     1.85506
                              |
           1.htdiag_or_highbp |   1.006849   .0472906     0.15   0.884     .9182992    1.103937
1.chronic_respiratory_disease |   2.203444   .1226249    14.20   0.000     1.975748    2.457382
                              |
                    asthmacat |
                 Yes, no OCS  |   1.055772   .0648519     0.88   0.377      .936018    1.190848
                Yes with OCS  |    1.38814   .1578129     2.88   0.004      1.11087    1.734617
                              |
    1.chronic_cardiac_disease |   1.331594   .0625807     6.09   0.000     1.214418    1.460077
                              |
                      diabcat |
         Controlled diabetes  |    1.66286   .0870773     9.71   0.000     1.500658    1.842594
       Uncontrolled diabetes  |   2.754662    .185454    15.05   0.000     2.414139    3.143217
  Diabetes, no hba1c measure  |   2.185521   .2511026     6.81   0.000     1.744847    2.737491
                              |
            cancer_exhaem_cat |
                   Last year  |    2.04416    .338392     4.32   0.000     1.477768    2.827636
               2-5 years ago  |   1.313854   .1348494     2.66   0.008     1.074441    1.606614
                    5+ years  |    1.02861   .0724092     0.40   0.689     .8960464    1.180787
                              |
              cancer_haem_cat |
                   Last year  |   5.154995    2.08032     4.06   0.000     2.337342    11.36931
               2-5 years ago  |   5.600877   1.209605     7.98   0.000     3.667959     8.55239
                    5+ years  |   1.888256    .293576     4.09   0.000     1.392261    2.560951
                              |
      1.chronic_liver_disease |   1.992531   .3002879     4.57   0.000     1.482938    2.677237
            1.stroke_dementia |   1.737575   .1090622     8.80   0.000     1.536443    1.965038
                1.other_neuro |   2.936557   .3322108     9.52   0.000      2.35257    3.665509
                              |
  reduced_kidney_function_cat |
    Stage 3a/3b egfr 30-60    |   1.593396   .0788032     9.42   0.000     1.446194    1.755581
           Stage 4/5 egfr<30  |   4.880094   .5312233    14.56   0.000     3.942489     6.04068
                              |
           1.organ_transplant |   3.647538    .847824     5.57   0.000     2.312857    5.752424
                     1.spleen |   1.613431   .5629936     1.37   0.170     .8141986    3.197203
           1.ra_sle_psoriasis |   1.351306   .0979228     4.15   0.000     1.172387    1.557529
    1.other_immunosuppression |   2.219762   .4830912     3.66   0.000     1.448964    3.400596
                              |
                       region |
               East Midlands  |   .8506132   .0531447    -2.59   0.010     .7525765    .9614209
                      London  |   2.045256   .1578959     9.27   0.000     1.758062    2.379367
                  North East  |   .7186378   .0713489    -3.33   0.001     .5915613    .8730122
                  North West  |   .8789214   .0632469    -1.79   0.073     .7633045    1.012051
                  South East  |   .7643032   .0765298    -2.68   0.007     .6281087    .9300292
                  South West  |    .439063   .0365386    -9.89   0.000     .3729842    .5168486
               West Midlands  |    1.92446   .1624605     7.75   0.000     1.630991    2.270734
    Yorkshire and The Humber  |   .8086844   .0546241    -3.14   0.002     .7084074    .9231559
                              |
                         time |
                           3  |   76.79172   31.33761    10.64   0.000     34.51049    170.8747
                           4  |   451.3463   185.3049    14.89   0.000     201.8553    1009.205
                           5  |   723.9713   297.4164    16.03   0.000     323.6213    1619.592
                              |
                        _cons |   4.32e-08   4.91e-08   -14.93   0.000     4.67e-09    4.01e-07
-----------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.

.  
. 
. * Obtain absolute predictions, correcting the intercept for the control sampling
. predict xb, xb
(8 missing values generated)

. replace xb = xb + log($sampling_frac) 
(159,518 real changes made)

. gen risk28 = exp(xb)/(1 + exp(xb))
(8 missing values generated)

. 
. 
. 
. /*  Quantiles of predicted 28 day risk   */
. 
. centile risk28, c(10 20 30 40 50 60 70 80 90)

                                                       -- Binom. Interp. --
    Variable |       Obs  Percentile    Centile        [95% Conf. Interval]
-------------+-------------------------------------------------------------
      risk28 |   159,518         10    3.09e-08        3.00e-08    3.19e-08
             |                   20    2.39e-07        2.31e-07    2.47e-07
             |                   30    1.05e-06        1.02e-06    1.08e-06
             |                   40    2.85e-06        2.79e-06    2.91e-06
             |                   50    6.70e-06        6.58e-06    6.84e-06
             |                   60    .0000151        .0000148    .0000154
             |                   70     .000035        .0000343    .0000356
             |                   80    .0000927        .0000909    .0000947
             |                   90    .0003619        .0003527     .000372

. 
. 
. 
. 
. *************************************
. *   Summarise risks by comorbidity  *
. *************************************
. 
. 
. /*  Post into dataset   */
. 
. tempname temprf 

. 
. postfile `temprf' str30(rf) rfcat sex age risk28 using ///
>         output/abs_risks_logistic, replace
(note: file output/abs_risks_logistic.dta not found)

. 
.         * Binary risk factors
.         foreach var of varlist                                          ///
>                                 htdiag_or_highbp                                ///
>                                 chronic_respiratory_disease     ///
>                                 chronic_cardiac_disease                 ///
>                                 chronic_liver_disease                   ///
>                                 stroke_dementia                                 ///
>                                 other_neuro                                             ///
>                                 organ_transplant                                ///
>                                 spleen                                                  ///
>                                 ra_sle_psoriasis                                ///
>                                 other_immunosuppression    {
  2.                                         
.                 forvalues i = 1 (1) 6 {
  3.                         forvalues j = 0 (1) 1 {
  4.                                 forvalues k = 0 (1) 1 {
  5. 
.                                         * Mean risk of event among age and sex group
.                                         qui summ risk28 if  `var'==`k' 
  6.                                         local r28 = r(mean)
  7.                                         
.                                         post `temprf'  ("`var'") (`k') (`j') (`i') (`r28')
  8.                                 }
  9.                         }
 10.                 }
 11.         }

. 
.         * Categorical risk factors
.         local max_obese4cat                     = 4

.         local max_smoke_nomiss                  = 3     

.         local max_imd                                   = 5     

.         local max_asthmacat                             = 3     

.         local max_diabcat                               = 4     

.         local max_cancer_exhaem_cat             = 4      

.         local max_cancer_haem_cat               = 4 

.         local max_reduced_kidney_function_cat = 3

.                                         
.         foreach var of varlist                                          ///
>                                 obese4cat                                               ///
>                                 smoke_nomiss                                    ///
>                                 imd                                                     ///
>                                 asthmacat                                               ///
>                                 diabcat                                                 ///
>                                 cancer_exhaem_cat                               ///
>                                 cancer_haem_cat                                 ///
>                                 reduced_kidney_function_cat    {
  2.                                         
.                 forvalues i = 1 (1) 6 {
  3.                         forvalues j = 0 (1) 1 { 
  4.                                 forvalues k = 1 (1) `max_`var'' {
  5.                                         
.                                         * Mean risk of event among age and sex group
.                                         qui summ risk28 if  `var'==`k'
  6.                                         local r28 = r(mean)
  7.                                                         
.                                         post `temprf'  ("`var'") (`k')  (`j') (`i') (`r28') 
  8.                                 }
  9.                         }
 10.                 }
 11.         }

.         
.         
.         /*  Grouped comorbidity  */
.         
.         * Smoking with no other disease vs other disease 
.         forvalues i = 1 (1) 6 {
  2.                 forvalues j = 0 (1) 1 { 
  3.                         forvalues k = 1 (1) `max_smoke_nomiss' {
  4.                                 forvalues l = 0 (1) 1 {
  5.                                         
.                                         * Mean risk of event among age and sex group
.                                         qui summ risk28 if  smoke_nomiss==`k' & comorbidity_any==`l'
  6.                                         local r28 = r(mean)
  7.                                         
.                                         post `temprf'  ("Smoking, comorb=`l'") (`k')  (`j') (`i') (`r
> 28') 
  8.                                 }
  9.                         }
 10.                 }
 11.         }

.         
.         
.         * Other comorbidity groups?
.         
.         
. postclose `temprf'

. 
. 
. 
. use "output/abs_risks_logistic", clear

. outsheet using "output/abs_risks_logistic", replace
(note: file output/abs_risks_logistic.out not found)

. erase "output/abs_risks_logistic.dta"

. 
. 
. 
. 
. 
. 
end of do-file

