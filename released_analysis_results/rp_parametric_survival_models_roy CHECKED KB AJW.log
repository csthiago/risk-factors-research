-------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/rp_parametric_survival_m
> odels_roy.log
  log type:  text
 opened on:  15 May 2020, 20:55:02

. 
. use "cr_create_analysis_dataset_STSET_cpnsdeath.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. *************************************************
. *   Use a complete case analysis for ethnicity  *
. *************************************************
. 
. drop if ethnicity>=.
(4,563,711 observations deleted)

. 
. 
. 
. 
. ********************************************
. *   Comorbidity counts for assessing risk  *
. ********************************************
. 
. * Create absent/present for categorical comorbidities
. recode asthma 1=0 2/3=1, gen(asthmabin)
(2066223 differences between asthma and asthmabin)

. recode diabcat 1=0 2/4=1, gen(diabbin)
(12719568 differences between diabcat and diabbin)

. recode cancer_exhaem_cat 1=0 2/4=1, gen(cancer_exhaem_bin)
(12719568 differences between cancer_exhaem_cat and cancer_exhaem_bin)

. recode cancer_haem_cat 1=0 2/4=1, gen(cancer_haem_bin)
(12719568 differences between cancer_haem_cat and cancer_haem_bin)

. recode reduced_kidney_function_cat 1=0 2/3=1, gen(kidneybin)
(12719568 differences between reduced_kidney_function_cat and kidneybin)

. 
. * Count comorbidities present
. egen comorbidity_count = rowtotal(                      ///
>                         htdiag_or_highbp                                ///
>                         chronic_respiratory_disease     ///
>                         asthmabin                                               ///
>                         chronic_cardiac_disease                 ///
>                         diabbin                                                 ///
>                         cancer_exhaem_bin                               ///
>                         cancer_haem_bin                                 ///
>                         chronic_liver_disease                   ///
>                         stroke_dementia                                 ///
>                         kidneybin                                               ///
>                         other_neuro                                             ///
>                         organ_transplant                                ///
>                         spleen                                                  ///
>                         ra_sle_psoriasis                                ///
>                         other_immunosuppression                 ///
>                         )

. drop asthmabin diabbin cancer_exhaem_bin cancer_haem_bin kidneybin

. 
. recode comorbidity_count 1/max=1 0=0, gen(comorbidity_any)
(2489860 differences between comorbidity_count and comorbidity_any)

. 
. 
. * Create numerical region variable
. encode region, gen(region_new)

. drop region

. rename region_new region

. 
. 
. 
. 
. 
. *********************
. *   Royston-Parmar  *
. *********************
. 
. 
. rename reduced_kidney_function_cat red_kidney_cat

. rename chronic_respiratory_disease respiratory_disease

. rename chronic_cardiac_disease cardiac_disease

. rename other_immunosuppression immunosuppression

. 
. 
. * Create dummy variables for categorical predictors 
. foreach var of varlist obese4cat smoke_nomiss imd               ///
>         asthmacat diabcat cancer_exhaem_cat cancer_haem_cat ///
>         red_kidney_cat  region                                  ///
>         {
  2.                 egen ord_`var' = group(`var')
  3.                 qui summ ord_`var'
  4.                 local max=r(max)
  5.                 forvalues i = 1 (1) `max' {
  6.                         gen `var'_`i' = (`var'==`i')
  7.                 }       
  8.                 drop ord_`var'
  9.                 drop `var'_1
 10. }
(498 missing values generated)

. 
. 
. timer clear 1

. timer on 1

. stpm2  age1 age2 age3 male                                      ///
>                         obese4cat_*                                             ///
>                         smoke_nomiss_*                                  ///
>                         imd_*                                                   ///
>                         htdiag_or_highbp                                ///
>                         respiratory_disease                             ///
>                         asthmacat_*                                             ///
>                         cardiac_disease                                 ///
>                         diabcat_*                                               ///
>                         cancer_exhaem_cat_*                             ///
>                         cancer_haem_cat_*                               ///
>                         chronic_liver_disease                   ///
>                         stroke_dementia                                 ///
>                         other_neuro                                             ///
>                         red_kidney_cat_*                                ///
>                         organ_transplant                                ///
>                         spleen                                                  ///
>                         ra_sle_psoriasis                                ///
>                         immunosuppression                               ///
>                         region_*,                                               ///
>                         scale(hazard) df(5) eform

Iteration 0:   log likelihood = -28067.121  
Iteration 1:   log likelihood = -28024.555  
Iteration 2:   log likelihood = -28024.071  
Iteration 3:   log likelihood = -28024.071  

Log likelihood = -28024.071                     Number of obs     = 12,719,249

---------------------------------------------------------------------------------------
                      |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------+----------------------------------------------------------------
xb                    |
                 age1 |   1.122397   .0305922     4.24   0.000     1.064011    1.183987
                 age2 |   .9722753   .0592092    -0.46   0.644     .8628854    1.095533
                 age3 |   1.027584   .1467985     0.19   0.849     .7766344    1.359623
                 male |   1.930843   .0642457    19.77   0.000     1.808942    2.060959
          obese4cat_2 |   1.248203   .0495616     5.58   0.000     1.154748    1.349222
          obese4cat_3 |   1.538108   .0890402     7.44   0.000     1.373129    1.722909
          obese4cat_4 |   2.151551    .166274     9.91   0.000     1.849141    2.503418
       smoke_nomiss_2 |   1.232373   .0441804     5.83   0.000     1.148753     1.32208
       smoke_nomiss_3 |   .8746714   .0580738    -2.02   0.044     .7679437    .9962319
                imd_2 |   1.154662   .0623881     2.66   0.008     1.038636     1.28365
                imd_3 |   1.185241   .0634705     3.17   0.002     1.067147    1.316404
                imd_4 |   1.481083   .0769679     7.56   0.000     1.337657    1.639887
                imd_5 |   1.680882   .0885135     9.86   0.000     1.516051    1.863634
     htdiag_or_highbp |   .9762885   .0372069    -0.63   0.529     .9060212    1.052005
  respiratory_disease |    1.78297   .0697287    14.79   0.000      1.65141    1.925009
          asthmacat_2 |   1.048967   .0497255     1.01   0.313     .9558969    1.151098
          asthmacat_3 |   1.278201   .1046211     3.00   0.003     1.088749    1.500618
      cardiac_disease |   1.245012   .0433695     6.29   0.000     1.162846    1.332983
            diabcat_2 |   1.557276   .0606978    11.36   0.000     1.442741    1.680903
            diabcat_3 |   2.295585   .1100389    17.34   0.000     2.089734    2.521713
            diabcat_4 |   2.042069   .1644033     8.87   0.000     1.743981    2.391108
  cancer_exhaem_cat_2 |   1.655064   .1831591     4.55   0.000     1.332342    2.055955
  cancer_exhaem_cat_3 |   1.176743   .0900599     2.13   0.033      1.01283    1.367183
  cancer_exhaem_cat_4 |   .9903393   .0516942    -0.19   0.852     .8940311    1.097022
    cancer_haem_cat_2 |   3.144796   .7243265     4.97   0.000     2.002346    4.939078
    cancer_haem_cat_3 |    3.32581   .4199411     9.52   0.000      2.59668    4.259674
    cancer_haem_cat_4 |   1.784882   .2101793     4.92   0.000      1.41702    2.248242
chronic_liver_disease |   1.601157   .1754664     4.30   0.000     1.291675    1.984791
      stroke_dementia |   1.736865   .0742347    12.92   0.000     1.597295    1.888631
          other_neuro |   2.407649   .1659861    12.74   0.000     2.103344    2.755979
     red_kidney_cat_2 |   1.595532   .0601713    12.39   0.000     1.481851    1.717934
     red_kidney_cat_3 |   3.450199    .208294    20.51   0.000     3.065179    3.883583
     organ_transplant |   4.055268   .6469959     8.78   0.000       2.9663    5.544012
               spleen |   1.415751   .3352626     1.47   0.142     .8900508    2.251952
     ra_sle_psoriasis |   1.157536   .0628751     2.69   0.007     1.040636    1.287568
    immunosuppression |   1.908379   .3169101     3.89   0.000     1.378199    2.642513
             region_2 |   .7694271   .0378898    -5.32   0.000     .6986356    .8473917
             region_3 |   1.725179   .1004244     9.37   0.000     1.539163    1.933674
             region_4 |   .7141145   .0564795    -4.26   0.000     .6115698    .8338532
             region_5 |   .8475784   .0484652    -2.89   0.004     .7577179    .9480958
             region_6 |    .682932   .0553329    -4.71   0.000     .5826542    .8004682
             region_7 |   .4192319   .0288775   -12.62   0.000     .3662873    .4798293
             region_8 |   1.677508   .1054047     8.23   0.000     1.483133    1.897357
             region_9 |   .7739573   .0408441    -4.86   0.000     .6979053    .8582968
                _rcs1 |   2.572245   .1664464    14.60   0.000     2.265856    2.920064
                _rcs2 |   1.173955   .0217181     8.67   0.000     1.132151    1.217303
                _rcs3 |   1.004597   .0016331     2.82   0.005     1.001401    1.007803
                _rcs4 |   1.000045   .0002289     0.20   0.844     .9995965    1.000494
                _rcs5 |   1.000074   .0000606     1.22   0.222     .9999552    1.000193
                _cons |   9.40e-08   9.22e-08   -16.49   0.000     1.37e-08    6.43e-07
---------------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

. estat ic

Akaike's information criterion and Bayesian information criterion

-----------------------------------------------------------------------------
       Model |          N   ll(null)  ll(model)      df        AIC        BIC
-------------+---------------------------------------------------------------
           . | 12,719,249          .  -28024.07      50   56148.14   56866.07
-----------------------------------------------------------------------------
Note: BIC uses N = number of observations. See [R] BIC note.

. timer off 1

. timer list 1
   1:   1760.75 /        1 =    1760.7490

. 
. 
. 
. 
. 
. *****************************************************
. *   Survival predictions from Royston-Parmar model  *
. *****************************************************
. 
. gen time30 = 30

. gen time60 = 60

. gen time80 = 80

. 
. 
. * Survival at t
. predict surv_royp, surv timevar(_t)

. 
. * Survival at 30 days
. predict surv30_royp, surv timevar(time30)

. 
. * Survival at 60 days
. predict surv60_royp, surv timevar(time60)

. 
. * Survival at 80 days
. predict surv80_royp, surv timevar(time80)

. 
. 
. * Absolute risk at 30, 60 and 80 days
. gen risk_royp   = 1-surv_royp
(319 missing values generated)

. gen risk30_royp = 1-surv30_royp

. gen risk60_royp = 1-surv60_royp

. gen risk80_royp = 1-surv80_royp

. 
. 
. 
. 
. /*  Quantiles of predicted 30, 60 and 80 day risk   */
. 
. centile risk30_royp, c(10 20 30 40 50 60 70 80 90)

                                                       -- Binom. Interp. --
    Variable |       Obs  Percentile    Centile        [95% Conf. Interval]
-------------+-------------------------------------------------------------
 risk30_royp |12,719,568         10    1.22e-11        1.21e-11    1.22e-11
             |                   20    2.62e-11        2.61e-11    2.62e-11
             |                   30    5.02e-11        5.02e-11    5.03e-11
             |                   40    9.20e-11        9.18e-11    9.22e-11
             |                   50    1.65e-10        1.65e-10    1.65e-10
             |                   60    2.94e-10        2.93e-10    2.94e-10
             |                   70    5.42e-10        5.41e-10    5.42e-10
             |                   80    1.09e-09        1.08e-09    1.09e-09
             |                   90    2.71e-09        2.70e-09    2.71e-09

. centile risk60_royp, c(10 20 30 40 50 60 70 80 90)

                                                       -- Binom. Interp. --
    Variable |       Obs  Percentile    Centile        [95% Conf. Interval]
-------------+-------------------------------------------------------------
 risk60_royp |12,719,568         10    6.28e-07        6.27e-07    6.29e-07
             |                   20    1.35e-06        1.35e-06    1.35e-06
             |                   30    2.59e-06        2.59e-06    2.60e-06
             |                   40    4.75e-06        4.74e-06    4.76e-06
             |                   50    8.52e-06        8.51e-06    8.54e-06
             |                   60    .0000152        .0000151    .0000152
             |                   70     .000028        .0000279     .000028
             |                   80     .000056        .0000559    .0000561
             |                   90    .0001399        .0001397    .0001401

. centile risk80_royp, c(10 20 30 40 50 60 70 80 90)

                                                       -- Binom. Interp. --
    Variable |       Obs  Percentile    Centile        [95% Conf. Interval]
-------------+-------------------------------------------------------------
 risk80_royp |12,719,568         10    2.90e-06        2.90e-06    2.90e-06
             |                   20    6.25e-06        6.24e-06    6.25e-06
             |                   30     .000012         .000012     .000012
             |                   40    .0000219        .0000219     .000022
             |                   50    .0000394        .0000393    .0000395
             |                   60    .0000701        .0000699    .0000701
             |                   70    .0001292         .000129    .0001294
             |                   80    .0002588        .0002583    .0002593
             |                   90    .0006459        .0006448    .0006469

. 
. 
. 
. 
. *************************************
. *   Summarise risks by comorbidity  *
. *************************************
. 
. 
. /*  Post into dataset   */
. 
. tempname temprf 

. 
. postfile `temprf' str30(rf) rfcat sex age risk30 risk60 risk80  ///
>         using output/abs_risks_roy, replace
(note: file output/abs_risks_roy.dta not found)

. 
.         * Binary risk factors
.         foreach var of varlist                                          ///
>                                 htdiag_or_highbp                                ///
>                                 respiratory_disease                             ///
>                                 cardiac_disease                                 ///
>                                 chronic_liver_disease                   ///
>                                 stroke_dementia                                 ///
>                                 other_neuro                                             ///
>                                 organ_transplant                                ///
>                                 spleen                                                  ///
>                                 ra_sle_psoriasis                                ///
>                                 immunosuppression    {
  2.                                         
.                 forvalues i = 1 (1) 6 {
  3.                         forvalues j = 0 (1) 1 {
  4.                                 forvalues k = 0 (1) 1 {
  5. 
.                                         * Mean risk of event at 30 days among age and sex group
.                                         qui summ risk30 if  `var'==`k' & agegroup==`i' & male==`j'
  6.                                         local r30 = r(mean)
  7.                                         
.                                         * Mean risk of event at 60 days among age and sex group
.                                         qui summ risk60 if  `var'==`k' & agegroup==`i' & male==`j'
  8.                                         local r60 = r(mean)
  9.                                                                                 
.                                         * Mean risk of event at 80 days among age and sex group
.                                         qui summ risk80 if  `var'==`k'  & agegroup==`i' & male==`j'
 10.                                         local r80 = r(mean)
 11.                                         
.                                         post `temprf'  ("`var'") (`k') (`j') (`i') (`r30') (`r60') (`
> r80')
 12.                                 }
 13.                         }
 14.                 }
 15.         }

. 
.         * Categorical risk factors
.         local max_obese4cat                     = 4

.         local max_smoke_nomiss                  = 3     

.         local max_imd                                   = 5     

.         local max_asthmacat                             = 3     

.         local max_diabcat                               = 4     

.         local max_cancer_exhaem_cat             = 4      

.         local max_cancer_haem_cat               = 4 

.         local max_red_kidney_cat                = 3

.                                         
.         foreach var of varlist                                          ///
>                                 obese4cat                                               ///
>                                 smoke_nomiss                                    ///
>                                 imd                                                     ///
>                                 asthmacat                                               ///
>                                 diabcat                                                 ///
>                                 cancer_exhaem_cat                               ///
>                                 cancer_haem_cat                                 ///
>                                 red_kidney_cat                                  {
  2.                                         
.                 forvalues i = 1 (1) 6 {
  3.                         forvalues j = 0 (1) 1 { 
  4.                                 forvalues k = 1 (1) `max_`var'' {
  5.                                         
.                                         * Mean risk of event at 30 days among age and sex group
.                                         qui summ risk30 if  `var'==`k' & agegroup==`i' & male==`j' 
  6.                                         local r30 = r(mean)
  7.                                         
.                                         * Mean risk of event at 60 days among age and sex group
.                                         qui summ risk60 if  `var'==`k' & agegroup==`i' & male==`j'
  8.                                         local r60 = r(mean)
  9.                                                                                 
.                                         * Mean risk of event at 80 days among age and sex group
.                                         qui summ risk80 if  `var'==`k' & agegroup==`i' & male==`j'
 10.                                         local r80 = r(mean)
 11.                                         
.                                         
.                                         post `temprf'  ("`var'") (`k')  (`j') (`i') (`r30') (`r60') (
> `r80')
 12.                                 }
 13.                         }
 14.                 }
 15.         }

.         
.         
.         /*  Grouped comorbidity  */
.         
.         * Smoking with no other disease vs other disease 
.         forvalues i = 1 (1) 6 {
  2.                 forvalues j = 0 (1) 1 { 
  3.                         forvalues k = 1 (1) `max_smoke_nomiss' {
  4.                                 forvalues l = 0 (1) 1 {
  5.                                                                                 
.                                         * Mean risk of event at 30 days among age and sex group
.                                         qui summ risk30 if smoke_nomiss==`k'  & agegroup==`i' & male=
> =`j' & comorbidity_any==`l'
  6.                                         local r30 = r(mean)
  7.                                         
.                                         * Mean risk of event at 60 days among age and sex group
.                                         qui summ risk60 if smoke_nomiss==`k'  & agegroup==`i' & male=
> =`j' & comorbidity_any==`l'
  8.                                         local r60 = r(mean)
  9.                                         
.                                         * Mean risk of event at 80 days among age and sex group
.                                         qui summ risk80 if smoke_nomiss==`k'  & agegroup==`i' & male=
> =`j' & comorbidity_any==`l'
 10.                                         local r80 = r(mean)
 11.                                         
.                                         post `temprf'  ("Smoking, comorb=`l'") (`k')  (`j') (`i') (`r
> 30') (`r60') (`r80')
 12.                                 }
 13.                         }
 14.                 }
 15.         }

.         
.         
.         * Other comorbidity groups?
.         
.         
. postclose `temprf'

. 
. 
. preserve

. use "output/abs_risks_roy", clear

. outsheet using "output/abs_risks_roy", replace
(note: file output/abs_risks_roy.out not found)

. erase "output/abs_risks_roy.dta"

. restore

. 
. 
. 
. 
. 
. 
. *********************************************************
. *   Obtain predicted risks by comorbidity with 95% CIs  *
. *********************************************************
. 
. 
. bysort agegroup (age): gen order = _n

. bysort agegroup (age): gen revorder = _N - _n

. gen diff = abs(order-revord)

. keep if diff<=1
(12,719,558 observations deleted)

. bysort agegroup: keep if _n==1
(4 observations deleted)

. 
. keep agegroup age? _rcs1- _d_rcs5  _st _d _t _t0

. 
. expand 2
(6 observations created)

. bysort agegroup: gen male = _n-1

. 
. gen time30 = 30

. gen time60 = 60

. gen time80 = 80

. 
. 
. /*  Initially set values to "no comorbidity"  */
.                 
. gen htdiag_or_highbp                    = 0      

. gen respiratory_disease                 = 0

. gen asthmacat_2                                 = 0

. gen asthmacat_3                                 = 0

. gen cardiac_disease                     = 0

. gen diabcat_2                                   = 0

. gen diabcat_3                                   = 0

. gen diabcat_4                                   = 0

. gen cancer_exhaem_cat_2                 = 0

. gen cancer_exhaem_cat_3                 = 0     

. gen cancer_exhaem_cat_4                 = 0

. gen cancer_haem_cat_2                   = 0

. gen cancer_haem_cat_3                   = 0

. gen cancer_haem_cat_4                   = 0

. gen chronic_liver_disease               = 0

. gen stroke_dementia                     = 0

. gen other_neuro                                 = 0

. gen red_kidney_cat_2                    = 0

. gen red_kidney_cat_3                    = 0

. gen organ_transplant                    = 0

. gen spleen                                              = 0

. gen ra_sle_psoriasis                    = 0

. gen immunosuppression                   = 0

. 
. gen smoke_nomiss_2 = 0

. gen smoke_nomiss_3 =0                    

. gen obese4cat_2 =0 

. gen obese4cat_3 =0 

. gen obese4cat_4 =0                                      

. gen imd_2 =0 

. gen imd_3 =1 

. gen imd_4 =0 

. gen imd_5 =0                                                    

. gen region_2= 0 

. gen region_3= 0 

. gen region_4= 0 

. gen region_5= 1                                 

. gen region_6= 0 

. gen region_7= 0 

. gen region_8= 0 

. gen region_9= 0                 

. 
. 
. 
. /*  Predict survival at 80 days under each comorbidity separately   */
. 
. * Set age and sex to baseline values
. gen cons = 0

. 
. foreach var of varlist cons                             ///
>                 htdiag_or_highbp                                        ///
>                 respiratory_disease                             ///
>                 asthmacat_2                                             ///
>                 asthmacat_3                                             ///     
>                 cardiac_disease                                         ///
>                 diabcat_2                                                       ///
>                 diabcat_3                                                       ///
>                 diabcat_4                                                       ///     
>                 cancer_exhaem_cat_2                             ///
>                 cancer_exhaem_cat_3                             ///
>                 cancer_exhaem_cat_4                             ///
>                 cancer_haem_cat_2                                       ///
>                 cancer_haem_cat_3                                       ///
>                 cancer_haem_cat_4                                       ///
>                 chronic_liver_disease                           ///
>                 stroke_dementia                                         ///
>                 other_neuro                                                     ///
>                 red_kidney_cat_2                                        ///
>                 red_kidney_cat_3                                        ///
>                 organ_transplant                                        ///
>                 spleen                                                          ///
>                 ra_sle_psoriasis                                        ///
>                 immunosuppression                                       ///
>                 male {
  2.                                 
.         * Reset that value to "yes"
.         replace `var' = 1
  3.         
.         * Predict under that comorbidity (age and sex left at original values)
.         predict pred30_`var', surv timevar(time30) ci
  4.         predict pred60_`var', surv timevar(time60) ci
  5.         predict pred80_`var', surv timevar(time80) ci
  6.                                 
.         * Reset that value back to "no"
.         replace `var' = 0
  7. }
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(12 real changes made)
(6 real changes made)
(12 real changes made)

. 
. keep agegroup male pred*

. outsheet using "output/abs_risks2_roy", replace
(note: file output/abs_risks2_roy.out not found)

. 
. 
. 
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-risk-factors-research-full\analysis\output/rp_parametric_survival_m
> odels_roy.log
  log type:  text
 closed on:  15 May 2020, 23:28:31
-------------------------------------------------------------------------------------------------------
